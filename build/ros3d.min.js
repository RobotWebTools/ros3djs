var ROS3D=ROS3D||{REVISION:"0.13.0-SNAPSHOT"};ROS3D.MARKER_ARROW=0,ROS3D.MARKER_CUBE=1,ROS3D.MARKER_SPHERE=2,ROS3D.MARKER_CYLINDER=3,ROS3D.MARKER_LINE_STRIP=4,ROS3D.MARKER_LINE_LIST=5,ROS3D.MARKER_CUBE_LIST=6,ROS3D.MARKER_SPHERE_LIST=7,ROS3D.MARKER_POINTS=8,ROS3D.MARKER_TEXT_VIEW_FACING=9,ROS3D.MARKER_MESH_RESOURCE=10,ROS3D.MARKER_TRIANGLE_LIST=11,ROS3D.INTERACTIVE_MARKER_KEEP_ALIVE=0,ROS3D.INTERACTIVE_MARKER_POSE_UPDATE=1,ROS3D.INTERACTIVE_MARKER_MENU_SELECT=2,ROS3D.INTERACTIVE_MARKER_BUTTON_CLICK=3,ROS3D.INTERACTIVE_MARKER_MOUSE_DOWN=4,ROS3D.INTERACTIVE_MARKER_MOUSE_UP=5,ROS3D.INTERACTIVE_MARKER_NONE=0,ROS3D.INTERACTIVE_MARKER_MENU=1,ROS3D.INTERACTIVE_MARKER_BUTTON=2,ROS3D.INTERACTIVE_MARKER_MOVE_AXIS=3,ROS3D.INTERACTIVE_MARKER_MOVE_PLANE=4,ROS3D.INTERACTIVE_MARKER_ROTATE_AXIS=5,ROS3D.INTERACTIVE_MARKER_MOVE_ROTATE=6,ROS3D.INTERACTIVE_MARKER_INHERIT=0,ROS3D.INTERACTIVE_MARKER_FIXED=1,ROS3D.INTERACTIVE_MARKER_VIEW_FACING=2,ROS3D.COLLADA_LOADER=1,ROS3D.COLLADA_LOADER_2=2,ROS3D.makeColorMaterial=function(a,b,c,d){var e=new THREE.Color;return e.setRGB(a,b,c),.99>=d?new THREE.MeshBasicMaterial({color:e.getHex(),opacity:d+.1,transparent:!0,depthWrite:!0,blendSrc:THREE.SrcAlphaFactor,blendDst:THREE.OneMinusSrcAlphaFactor,blendEquation:THREE.ReverseSubtractEquation,blending:THREE.NormalBlending}):new THREE.MeshLambertMaterial({color:e.getHex(),opacity:d,blending:THREE.NormalBlending})},ROS3D.intersectPlane=function(a,b,c){var d=new THREE.Vector3,e=new THREE.Vector3;d.subVectors(b,a.origin);var f=a.direction.dot(c);if(Math.abs(f)<a.precision)return void 0;var g=c.dot(d)/f;return e.addVectors(a.origin,a.direction.clone().multiplyScalar(g)),e},ROS3D.findClosestPoint=function(a,b){var c=new THREE.Vector3;c.subVectors(a.origin,b.origin);var d=b.direction.clone(),e=a.direction.clone(),f=c.dot(d),g=d.dot(e),h=c.dot(e),i=d.dot(d),j=e.dot(e),k=j*i-g*g;if(Math.abs(k)<=1e-4)return void 0;var l=f*g-h*i,m=l/k;return m},ROS3D.closestAxisPoint=function(a,b,c){var d=new THREE.Projector,e=a.origin.clone();d.projectVector(e,b);var f=a.direction.clone().add(a.origin);d.projectVector(f,b);var g=f.clone().sub(e),h=new THREE.Vector2,i=h.subVectors(c,e).dot(g)/g.dot(g),j=new THREE.Vector2;j.addVectors(e,g.clone().multiplyScalar(i));var k=new THREE.Vector3(j.x,j.y,.5);d.unprojectVector(k,b);var l=new THREE.Ray(b.position,k.sub(b.position).normalize());return ROS3D.findClosestPoint(a,l)},ROS3D.DepthCloud=function(a){a=a||{},THREE.Object3D.call(this),this.url=a.url,this.f=a.f||526,this.pointSize=a.pointSize||3,this.width=a.width||1024,this.height=a.height||1024,this.whiteness=a.whiteness||0,this.varianceThreshold=a.varianceThreshold||16667e-9;this.video=document.createElement("video"),this.video.addEventListener("loadedmetadata",this.metaLoaded.bind(this),!1),this.video.loop=!0,this.video.src=this.url,this.video.crossOrigin="Anonymous",this.video.setAttribute("crossorigin","Anonymous"),this.vertex_shader=["uniform sampler2D map;","","uniform float width;","uniform float height;","uniform float nearClipping, farClipping;","","uniform float pointSize;","uniform float zOffset;","","uniform float focallength;","","varying vec2 vUvP;","varying vec2 colorP;","","varying float depthVariance;","varying float maskVal;","","float sampleDepth(vec2 pos)","  {","    float depth;","    ","    vec2 vUv = vec2( pos.x / (width*2.0), pos.y / (height*2.0)+0.5 );","    vec2 vUv2 = vec2( pos.x / (width*2.0)+0.5, pos.y / (height*2.0)+0.5 );","    ","    vec4 depthColor = texture2D( map, vUv );","    ","    depth = ( depthColor.r + depthColor.g + depthColor.b ) / 3.0 ;","    ","    if (depth>0.99)","    {","      vec4 depthColor2 = texture2D( map, vUv2 );","      float depth2 = ( depthColor2.r + depthColor2.g + depthColor2.b ) / 3.0 ;","      depth = 0.99+depth2;","    }","    ","    return depth;","  }","","float median(float a, float b, float c)","  {","    float r=a;","    ","    if ( (a<b) && (b<c) )","    {","      r = b;","    }","    if ( (a<c) && (c<b) )","    {","      r = c;","    }","    return r;","  }","","float variance(float d1, float d2, float d3, float d4, float d5, float d6, float d7, float d8, float d9)","  {","    float mean = (d1 + d2 + d3 + d4 + d5 + d6 + d7 + d8 + d9) / 9.0;","    float t1 = (d1-mean);","    float t2 = (d2-mean);","    float t3 = (d3-mean);","    float t4 = (d4-mean);","    float t5 = (d5-mean);","    float t6 = (d6-mean);","    float t7 = (d7-mean);","    float t8 = (d8-mean);","    float t9 = (d9-mean);","    float v = (t1*t1+t2*t2+t3*t3+t4*t4+t5*t5+t6*t6+t7*t7+t8*t8+t9*t9)/9.0;","    return v;","  }","","vec2 decodeDepth(vec2 pos)","  {","    vec2 ret;","    ","    ","    float depth1 = sampleDepth(vec2(position.x-1.0, position.y-1.0));","    float depth2 = sampleDepth(vec2(position.x, position.y-1.0));","    float depth3 = sampleDepth(vec2(position.x+1.0, position.y-1.0));","    float depth4 = sampleDepth(vec2(position.x-1.0, position.y));","    float depth5 = sampleDepth(vec2(position.x, position.y));","    float depth6 = sampleDepth(vec2(position.x+1.0, position.y));","    float depth7 = sampleDepth(vec2(position.x-1.0, position.y+1.0));","    float depth8 = sampleDepth(vec2(position.x, position.y+1.0));","    float depth9 = sampleDepth(vec2(position.x+1.0, position.y+1.0));","    ","    float median1 = median(depth1, depth2, depth3);","    float median2 = median(depth4, depth5, depth6);","    float median3 = median(depth7, depth8, depth9);","    ","    ret.x = median(median1, median2, median3);","    ret.y = variance(depth1, depth2, depth3, depth4, depth5, depth6, depth7, depth8, depth9);","    ","    return ret;","    ","  }","","","void main() {","  ","  vUvP = vec2( position.x / (width*2.0), position.y / (height*2.0)+0.5 );","  colorP = vec2( position.x / (width*2.0)+0.5 , position.y / (height*2.0)  );","  ","  vec4 pos = vec4(0.0,0.0,0.0,0.0);","  depthVariance = 0.0;","  ","  if ( (vUvP.x<0.0)|| (vUvP.x>0.5) || (vUvP.y<0.5) || (vUvP.y>0.0))","  {","    vec2 smp = decodeDepth(vec2(position.x, position.y));","    float depth = smp.x;","    depthVariance = smp.y;","    ","    float z = -depth;","    ","    pos = vec4(","      ( position.x / width - 0.5 ) * z * (1000.0/focallength) * -1.0,","      ( position.y / height - 0.5 ) * z * (1000.0/focallength),","      (- z + zOffset / 1000.0) * 2.0,","      1.0);","    ","    vec2 maskP = vec2( position.x / (width*2.0), position.y / (height*2.0)  );","    vec4 maskColor = texture2D( map, maskP );","    maskVal = ( maskColor.r + maskColor.g + maskColor.b ) / 3.0 ;","  }","  ","  gl_PointSize = pointSize;","  gl_Position = projectionMatrix * modelViewMatrix * pos;","  ","}"].join("\n"),this.fragment_shader=["uniform sampler2D map;","uniform float varianceThreshold;","uniform float whiteness;","","varying vec2 vUvP;","varying vec2 colorP;","","varying float depthVariance;","varying float maskVal;","","","void main() {","  ","  vec4 color;","  ","  if ( (depthVariance>varianceThreshold) || (maskVal>0.5) ||(vUvP.x<0.0)|| (vUvP.x>0.5) || (vUvP.y<0.5) || (vUvP.y>1.0))","  {  ","    discard;","  }","  else ","  {","    color = texture2D( map, colorP );","    ","    float fader = whiteness /100.0;","    ","    color.r = color.r * (1.0-fader)+ fader;","    ","    color.g = color.g * (1.0-fader)+ fader;","    ","    color.b = color.b * (1.0-fader)+ fader;","    ","    color.a = 1.0;//smoothstep( 20000.0, -20000.0, gl_FragCoord.z / gl_FragCoord.w );","  }","  ","  gl_FragColor = vec4( color.r, color.g, color.b, color.a );","  ","}"].join("\n")},ROS3D.DepthCloud.prototype.__proto__=THREE.Object3D.prototype,ROS3D.DepthCloud.prototype.metaLoaded=function(){this.metaLoaded=!0,this.initStreamer()},ROS3D.DepthCloud.prototype.initStreamer=function(){if(this.metaLoaded){this.texture=new THREE.Texture(this.video),this.geometry=new THREE.Geometry;for(var a=0,b=this.width*this.height;b>a;a++){var c=new THREE.Vector3;c.x=a%this.width,c.y=Math.floor(a/this.width),this.geometry.vertices.push(c)}this.material=new THREE.ShaderMaterial({uniforms:{map:{type:"t",value:this.texture},width:{type:"f",value:this.width},height:{type:"f",value:this.height},focallength:{type:"f",value:this.f},pointSize:{type:"f",value:this.pointSize},zOffset:{type:"f",value:0},whiteness:{type:"f",value:this.whiteness},varianceThreshold:{type:"f",value:this.varianceThreshold}},vertexShader:this.vertex_shader,fragmentShader:this.fragment_shader}),this.mesh=new THREE.ParticleSystem(this.geometry,this.material),this.mesh.position.x=0,this.mesh.position.y=0,this.add(this.mesh);var d=this;setInterval(function(){d.video.readyState===d.video.HAVE_ENOUGH_DATA&&(d.texture.needsUpdate=!0)},1e3/30)}},ROS3D.DepthCloud.prototype.startStream=function(){this.video.play()},ROS3D.DepthCloud.prototype.stopStream=function(){this.video.pause()},ROS3D.InteractiveMarker=function(a){THREE.Object3D.call(this),THREE.EventDispatcher.call(this);var b=this;a=a||{};var c=a.handle;this.name=c.name;var d=a.camera,e=a.path||"/",f=a.loader||ROS3D.COLLADA_LOADER_2;this.dragging=!1,this.onServerSetPose({pose:c.pose}),this.dragStart={position:new THREE.Vector3,orientation:new THREE.Quaternion,positionWorld:new THREE.Vector3,orientationWorld:new THREE.Quaternion,event3d:{}},c.controls.forEach(function(a){b.add(new ROS3D.InteractiveMarkerControl({parent:b,handle:c,message:a,camera:d,path:e,loader:f}))}),c.menuEntries.length>0&&(this.menu=new ROS3D.InteractiveMarkerMenu({menuEntries:c.menuEntries,menuFontSize:c.menuFontSize}),this.menu.addEventListener("menu-select",function(a){b.dispatchEvent(a)}))},ROS3D.InteractiveMarker.prototype.__proto__=THREE.Object3D.prototype,ROS3D.InteractiveMarker.prototype.showMenu=function(a,b){this.menu&&this.menu.show(a,b)},ROS3D.InteractiveMarker.prototype.moveAxis=function(a,b,c){if(this.dragging){var d=a.currentControlOri,e=b.clone().applyQuaternion(d),f=this.dragStart.event3d.intersection.point,g=e.clone().applyQuaternion(this.dragStart.orientationWorld.clone()),h=new THREE.Ray(f,g),i=ROS3D.closestAxisPoint(h,c.camera,c.mousePos),j=new THREE.Vector3;j.addVectors(this.dragStart.position,e.clone().applyQuaternion(this.dragStart.orientation).multiplyScalar(i)),this.setPosition(a,j),c.stopPropagation()}},ROS3D.InteractiveMarker.prototype.movePlane=function(a,b,c){if(this.dragging){var d=a.currentControlOri,e=b.clone().applyQuaternion(d),f=this.dragStart.event3d.intersection.point,g=e.clone().applyQuaternion(this.dragStart.orientationWorld),h=ROS3D.intersectPlane(c.mouseRay,f,g),i=new THREE.Vector3;i.subVectors(h,f),i.add(this.dragStart.positionWorld),this.setPosition(a,i),c.stopPropagation()}},ROS3D.InteractiveMarker.prototype.rotateAxis=function(a,b,c){if(this.dragging){a.updateMatrixWorld();var d=a.currentControlOri,e=d.clone().multiply(b.clone()),f=new THREE.Vector3(1,0,0).applyQuaternion(e),g=this.dragStart.event3d.intersection.point,h=f.applyQuaternion(this.dragStart.orientationWorld),i=ROS3D.intersectPlane(c.mouseRay,g,h),j=new THREE.Ray(this.dragStart.positionWorld,h),k=ROS3D.intersectPlane(j,g,h),l=this.dragStart.orientationWorld.clone().multiply(e),m=l.clone().inverse();i.sub(k),i.applyQuaternion(m);var n=this.dragStart.event3d.intersection.point.clone();n.sub(k),n.applyQuaternion(m);var o=Math.atan2(i.y,i.z),p=Math.atan2(n.y,n.z),q=p-o,r=new THREE.Quaternion;r.setFromAxisAngle(f,q),this.setOrientation(a,r.multiply(this.dragStart.orientationWorld)),c.stopPropagation()}},ROS3D.InteractiveMarker.prototype.feedbackEvent=function(a,b){this.dispatchEvent({type:a,position:this.position.clone(),orientation:this.quaternion.clone(),controlName:b.name})},ROS3D.InteractiveMarker.prototype.startDrag=function(a,b){if(0===b.domEvent.button){b.stopPropagation(),this.dragging=!0,this.updateMatrixWorld(!0);var c=new THREE.Vector3;this.matrixWorld.decompose(this.dragStart.positionWorld,this.dragStart.orientationWorld,c),this.dragStart.position=this.position.clone(),this.dragStart.orientation=this.quaternion.clone(),this.dragStart.event3d=b,this.feedbackEvent("user-mousedown",a)}},ROS3D.InteractiveMarker.prototype.stopDrag=function(a,b){0===b.domEvent.button&&(b.stopPropagation(),this.dragging=!1,this.dragStart.event3d={},this.onServerSetPose(this.bufferedPoseEvent),this.bufferedPoseEvent=void 0,this.feedbackEvent("user-mouseup",a))},ROS3D.InteractiveMarker.prototype.buttonClick=function(a,b){b.stopPropagation(),this.feedbackEvent("user-button-click",a)},ROS3D.InteractiveMarker.prototype.setPosition=function(a,b){this.position=b,this.feedbackEvent("user-pose-change",a)},ROS3D.InteractiveMarker.prototype.setOrientation=function(a,b){b.normalize(),this.quaternion=b,this.feedbackEvent("user-pose-change",a)},ROS3D.InteractiveMarker.prototype.onServerSetPose=function(a){if(void 0!==a)if(this.dragging)this.bufferedPoseEvent=a;else{var b=a.pose;this.position.x=b.position.x,this.position.y=b.position.y,this.position.z=b.position.z,this.quaternion=new THREE.Quaternion(b.orientation.x,b.orientation.y,b.orientation.z,b.orientation.w),this.updateMatrixWorld(!0)}},ROS3D.InteractiveMarker.prototype.dispose=function(){var a=this;this.children.forEach(function(b){b.children.forEach(function(a){a.dispose(),b.remove(a)}),a.remove(b)})},THREE.EventDispatcher.prototype.apply(ROS3D.InteractiveMarker.prototype),ROS3D.InteractiveMarkerClient=function(a){a=a||{},this.ros=a.ros,this.tfClient=a.tfClient,this.topic=a.topic,this.path=a.path||"/",this.camera=a.camera,this.rootObject=a.rootObject||new THREE.Object3D,this.loader=a.loader||ROS3D.COLLADA_LOADER_2,this.menuFontSize=a.menuFontSize||"0.8em",this.interactiveMarkers={},this.updateTopic=null,this.feedbackTopic=null,this.topic&&this.subscribe(this.topic)},ROS3D.InteractiveMarkerClient.prototype.subscribe=function(a){this.unsubscribe(),this.updateTopic=new ROSLIB.Topic({ros:this.ros,name:a+"/tunneled/update",messageType:"visualization_msgs/InteractiveMarkerUpdate",compression:"png"}),this.updateTopic.subscribe(this.processUpdate.bind(this)),this.feedbackTopic=new ROSLIB.Topic({ros:this.ros,name:a+"/feedback",messageType:"visualization_msgs/InteractiveMarkerFeedback",compression:"png"}),this.feedbackTopic.advertise(),this.initService=new ROSLIB.Service({ros:this.ros,name:a+"/tunneled/get_init",serviceType:"demo_interactive_markers/GetInit"});var b=new ROSLIB.ServiceRequest({});this.initService.callService(b,this.processInit.bind(this))},ROS3D.InteractiveMarkerClient.prototype.unsubscribe=function(){this.updateTopic&&this.updateTopic.unsubscribe(),this.feedbackTopic&&this.feedbackTopic.unadvertise();for(var a in this.interactiveMarkers)this.eraseIntMarker(a);this.interactiveMarkers={}},ROS3D.InteractiveMarkerClient.prototype.processInit=function(a){var b=a.msg;b.erases=[];for(var c in this.interactiveMarkers)b.erases.push(c);b.poses=[],this.processUpdate(b)},ROS3D.InteractiveMarkerClient.prototype.processUpdate=function(a){var b=this;a.erases.forEach(function(a){b.eraseIntMarker(a)}),a.poses.forEach(function(a){var c=b.interactiveMarkers[a.name];c&&c.setPoseFromServer(a.pose)}),a.markers.forEach(function(a){var c=b.interactiveMarkers[a.name];c&&b.eraseIntMarker(c.name);var d=new ROS3D.InteractiveMarkerHandle({message:a,feedbackTopic:b.feedbackTopic,tfClient:b.tfClient,menuFontSize:b.menuFontSize});b.interactiveMarkers[a.name]=d;var e=new ROS3D.InteractiveMarker({handle:d,camera:b.camera,path:b.path,loader:b.loader});e.name=a.name,b.rootObject.add(e),d.on("pose",function(a){e.onServerSetPose({pose:a})}),e.addEventListener("user-pose-change",d.setPoseFromClient.bind(d)),e.addEventListener("user-mousedown",d.onMouseDown.bind(d)),e.addEventListener("user-mouseup",d.onMouseUp.bind(d)),e.addEventListener("user-button-click",d.onButtonClick.bind(d)),e.addEventListener("menu-select",d.onMenuSelect.bind(d)),d.subscribeTf()})},ROS3D.InteractiveMarkerClient.prototype.eraseIntMarker=function(a){if(this.interactiveMarkers[a]){var b=this.rootObject.getObjectByName(a);this.rootObject.remove(b),delete this.interactiveMarkers[a],b.dispose()}},ROS3D.InteractiveMarkerControl=function(a){function b(a){a.stopPropagation()}var c=this;THREE.Object3D.call(this),a=a||{},this.parent=a.parent;var d=a.handle,e=a.message;this.name=e.name,this.camera=a.camera,this.path=a.path||"/",this.loader=a.loader||ROS3D.COLLADA_LOADER_2,this.dragging=!1,this.startMousePos=new THREE.Vector2;var f=new THREE.Quaternion(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w);f.normalize();var g=new THREE.Vector3(1,0,0);switch(g.applyQuaternion(f),this.currentControlOri=new THREE.Quaternion,e.interaction_mode){case ROS3D.INTERACTIVE_MARKER_MOVE_AXIS:this.addEventListener("mousemove",this.parent.moveAxis.bind(this.parent,this,g)),this.addEventListener("touchmove",this.parent.moveAxis.bind(this.parent,this,g));break;case ROS3D.INTERACTIVE_MARKER_ROTATE_AXIS:this.addEventListener("mousemove",this.parent.rotateAxis.bind(this.parent,this,f));break;case ROS3D.INTERACTIVE_MARKER_MOVE_PLANE:this.addEventListener("mousemove",this.parent.movePlane.bind(this.parent,this,g));break;case ROS3D.INTERACTIVE_MARKER_BUTTON:this.addEventListener("click",this.parent.buttonClick.bind(this.parent,this))}e.interaction_mode!==ROS3D.INTERACTIVE_MARKER_NONE&&(this.addEventListener("mousedown",this.parent.startDrag.bind(this.parent,this)),this.addEventListener("mouseup",this.parent.stopDrag.bind(this.parent,this)),this.addEventListener("contextmenu",this.parent.showMenu.bind(this.parent,this)),this.addEventListener("mouseup",function(a){0===c.startMousePos.distanceToSquared(a.mousePos)&&(a.type="contextmenu",c.dispatchEvent(a))}),this.addEventListener("mouseover",b),this.addEventListener("mouseout",b),this.addEventListener("click",b),this.addEventListener("mousedown",function(a){c.startMousePos=a.mousePos}),this.addEventListener("touchstart",function(a){1===a.domEvent.touches.length&&(a.type="mousedown",a.domEvent.button=0,c.dispatchEvent(a))}),this.addEventListener("touchmove",function(a){1===a.domEvent.touches.length&&(a.type="mousemove",a.domEvent.button=0,c.dispatchEvent(a))}),this.addEventListener("touchend",function(a){0===a.domEvent.touches.length&&(a.domEvent.button=0,a.type="mouseup",c.dispatchEvent(a),a.type="click",c.dispatchEvent(a))}));{var h=new THREE.Quaternion;this.parent.position.clone().multiplyScalar(-1)}switch(e.orientation_mode){case ROS3D.INTERACTIVE_MARKER_INHERIT:h=this.parent.quaternion.clone().inverse(),this.updateMatrixWorld=function(a){ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(c,a),c.currentControlOri.copy(c.quaternion),c.currentControlOri.normalize()};break;case ROS3D.INTERACTIVE_MARKER_FIXED:this.updateMatrixWorld=function(a){c.quaternion=c.parent.quaternion.clone().inverse(),c.updateMatrix(),c.matrixWorldNeedsUpdate=!0,ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(c,a),c.currentControlOri.copy(c.quaternion)};break;case ROS3D.INTERACTIVE_MARKER_VIEW_FACING:var i=e.independent_marker_orientation;this.updateMatrixWorld=function(a){c.camera.updateMatrixWorld();var b=(new THREE.Matrix4).extractRotation(c.camera.matrixWorld),d=new THREE.Matrix4,e=.5*Math.PI,f=new THREE.Euler(-e,0,e);d.makeRotationFromEuler(f);var g=new THREE.Matrix4;g.getInverse(c.parent.matrixWorld),b.multiplyMatrices(b,d),b.multiplyMatrices(g,b),c.currentControlOri.setFromRotationMatrix(b),i||(c.quaternion.copy(c.currentControlOri),c.updateMatrix(),c.matrixWorldNeedsUpdate=!0),ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(c,a)};break;default:console.error("Unkown orientation mode: "+e.orientation_mode)}var j=new ROSLIB.TFClient({ros:d.tfClient.ros,fixedFrame:d.message.header.frame_id});e.markers.forEach(function(a){var b=function(b){var d=new ROS3D.Marker({message:a,path:c.path,loader:c.loader});if(null!==b){var e=new ROSLIB.Pose({position:d.position,quaternion:d.quaternion});e.applyTransform(new ROSLIB.Transform(b)),d.setPose(e),d.updateMatrixWorld(),j.unsubscribe(a.header.frame_id)}c.add(d)};""!==a.header.frame_id?j.subscribe(a.header.frame_id,b):b(null)})},ROS3D.InteractiveMarkerControl.prototype.__proto__=THREE.Object3D.prototype,ROS3D.InteractiveMarkerHandle=function(a){a=a||{},this.message=a.message,this.feedbackTopic=a.feedbackTopic,this.tfClient=a.tfClient,this.menuFontSize=a.menuFontSize||"0.8em",this.name=this.message.name,this.header=this.message.header,this.controls=this.message.controls,this.menuEntries=this.message.menu_entries,this.dragging=!1,this.timeoutHandle=null,this.tfTransform=new ROSLIB.Transform,this.pose=new ROSLIB.Pose,this.setPoseFromServer(this.message.pose)},ROS3D.InteractiveMarkerHandle.prototype.__proto__=EventEmitter2.prototype,ROS3D.InteractiveMarkerHandle.prototype.subscribeTf=function(){0===this.message.header.stamp.secs&&0===this.message.header.stamp.nsecs&&this.tfClient.subscribe(this.message.header.frame_id,this.tfUpdate.bind(this))},ROS3D.InteractiveMarkerHandle.prototype.emitServerPoseUpdate=function(){var a=new ROSLIB.Pose(this.pose);a.applyTransform(this.tfTransform),this.emit("pose",a)},ROS3D.InteractiveMarkerHandle.prototype.setPoseFromServer=function(a){this.pose=new ROSLIB.Pose(a),this.emitServerPoseUpdate()},ROS3D.InteractiveMarkerHandle.prototype.tfUpdate=function(a){this.tfTransform=new ROSLIB.Transform(a),this.emitServerPoseUpdate()},ROS3D.InteractiveMarkerHandle.prototype.setPoseFromClient=function(a){this.pose=new ROSLIB.Pose(a);var b=this.tfTransform.clone();b.rotation.invert(),b.translation.multiplyQuaternion(b.rotation),b.translation.x*=-1,b.translation.y*=-1,b.translation.z*=-1,this.pose.applyTransform(b),this.sendFeedback(ROS3D.INTERACTIVE_MARKER_POSE_UPDATE,void 0,0,a.controlName),this.dragging&&(this.timeoutHandle&&clearTimeout(this.timeoutHandle),this.timeoutHandle=setTimeout(this.setPoseFromClient.bind(this,a),250))},ROS3D.InteractiveMarkerHandle.prototype.onButtonClick=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_BUTTON_CLICK,a.clickPosition,0,a.controlName)},ROS3D.InteractiveMarkerHandle.prototype.onMouseDown=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MOUSE_DOWN,a.clickPosition,0,a.controlName),this.dragging=!0},ROS3D.InteractiveMarkerHandle.prototype.onMouseUp=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MOUSE_UP,a.clickPosition,0,a.controlName),this.dragging=!1,this.timeoutHandle&&clearTimeout(this.timeoutHandle)},ROS3D.InteractiveMarkerHandle.prototype.onMenuSelect=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MENU_SELECT,void 0,a.id,a.controlName)},ROS3D.InteractiveMarkerHandle.prototype.sendFeedback=function(a,b,c,d){var e=void 0!==b;b=b||{x:0,y:0,z:0};var f={header:this.header,client_id:this.clientID,marker_name:this.name,control_name:d,event_type:a,pose:this.pose,mouse_point:b,mouse_point_valid:e,menu_entry_id:c};this.feedbackTopic.publish(f)},ROS3D.InteractiveMarkerMenu=function(a){function b(a,b){this.dispatchEvent({type:"menu-select",domEvent:b,id:a.id,controlName:this.controlName}),this.hide(b)}function c(a,e){var f=document.createElement("ul");a.appendChild(f);for(var g=e.children,h=0;h<g.length;h++){var i=document.createElement("li"),j=document.createElement("div");j.appendChild(document.createTextNode(g[h].title)),f.appendChild(i),i.appendChild(j),g[h].children.length>0?(c(i,g[h]),j.addEventListener("click",d.hide.bind(d)),j.addEventListener("touchstart",d.hide.bind(d))):(j.addEventListener("click",b.bind(d,g[h])),j.addEventListener("touchstart",b.bind(d,g[h])),j.className="default-interactive-marker-menu-entry")}}var d=this;a=a||{};var e=a.menuEntries,f=a.className||"default-interactive-marker-menu",g=(a.entryClassName||"default-interactive-marker-menu-entry",a.overlayClassName||"default-interactive-marker-overlay"),h=a.menuFontSize||"0.8em",i=[];if(i[0]={children:[]},THREE.EventDispatcher.call(this),null===document.getElementById("default-interactive-marker-menu-css")){var j=document.createElement("style");j.id="default-interactive-marker-menu-css",j.type="text/css",j.innerHTML=".default-interactive-marker-menu {background-color: #444444;border: 1px solid #888888;border: 1px solid #888888;padding: 0px 0px 0px 0px;color: #FFFFFF;font-family: sans-serif;font-size: "+h+";z-index: 1002;}.default-interactive-marker-menu ul {padding: 0px 0px 5px 0px;margin: 0px;list-style-type: none;}.default-interactive-marker-menu ul li div {-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;cursor: default;padding: 3px 10px 3px 10px;}.default-interactive-marker-menu-entry:hover {  background-color: #666666;  cursor: pointer;}.default-interactive-marker-menu ul ul {  font-style: italic;  padding-left: 10px;}.default-interactive-marker-overlay {  position: absolute;  top: 0%;  left: 0%;  width: 100%;  height: 100%;  background-color: black;  z-index: 1001;  -moz-opacity: 0.0;  opacity: .0;  filter: alpha(opacity = 0);}",document.getElementsByTagName("head")[0].appendChild(j)}this.menuDomElem=document.createElement("div"),this.menuDomElem.style.position="absolute",this.menuDomElem.className=f,this.menuDomElem.addEventListener("contextmenu",function(a){a.preventDefault()}),this.overlayDomElem=document.createElement("div"),this.overlayDomElem.className=g,this.hideListener=this.hide.bind(this),this.overlayDomElem.addEventListener("contextmenu",this.hideListener),this.overlayDomElem.addEventListener("click",this.hideListener),this.overlayDomElem.addEventListener("touchstart",this.hideListener);var k,l,m;for(k=0;k<e.length;k++)l=e[k],m=l.id,i[m]={title:l.title,id:m,children:[]};for(k=0;k<e.length;k++){l=e[k],m=l.id;var n=i[m],o=i[l.parent_id];o.children.push(n)}c(this.menuDomElem,i[0])},ROS3D.InteractiveMarkerMenu.prototype.show=function(a,b){b&&b.preventDefault&&b.preventDefault(),this.controlName=a.name,void 0!==b.domEvent.changedTouches?(this.menuDomElem.style.left=b.domEvent.changedTouches[0].pageX+"px",this.menuDomElem.style.top=b.domEvent.changedTouches[0].pageY+"px"):(this.menuDomElem.style.left=b.domEvent.clientX+"px",this.menuDomElem.style.top=b.domEvent.clientY+"px"),document.body.appendChild(this.overlayDomElem),document.body.appendChild(this.menuDomElem)},ROS3D.InteractiveMarkerMenu.prototype.hide=function(a){a&&a.preventDefault&&a.preventDefault(),document.body.removeChild(this.overlayDomElem),document.body.removeChild(this.menuDomElem)},THREE.EventDispatcher.prototype.apply(ROS3D.InteractiveMarkerMenu.prototype),ROS3D.OccupancyGrid=function(a){a=a||{};var b=a.message,c=b.info.width,d=b.info.height,e=new THREE.PlaneGeometry(c,d),f=document.createElement("canvas");f.width=c,f.height=d;for(var g=f.getContext("2d"),h=g.createImageData(c,d),i=0;d>i;i++)for(var j=0;c>j;j++){var k,l=j+(d-i-1)*c,m=b.data[l];k=100===m?0:0===m?255:127;var n=4*(j+i*c);h.data[n]=k,h.data[++n]=k,h.data[++n]=k,h.data[++n]=255}g.putImageData(h,0,0);var o=new THREE.Texture(f);o.needsUpdate=!0;var p=new THREE.MeshBasicMaterial({map:o});p.side=THREE.DoubleSide,THREE.Mesh.call(this,e,p),this.position.x=c*b.info.resolution/2,this.position.y=d*b.info.resolution/2,this.scale.x=b.info.resolution,this.scale.y=b.info.resolution},ROS3D.OccupancyGrid.prototype.__proto__=THREE.Mesh.prototype,ROS3D.OccupancyGridClient=function(a){var b=this;a=a||{};var c=a.ros,d=a.topic||"/map";this.continuous=a.continuous,this.tfClient=a.tfClient,this.rootObject=a.rootObject||new THREE.Object3D,this.currentGrid=null;var e=new ROSLIB.Topic({ros:c,name:d,messageType:"nav_msgs/OccupancyGrid",compression:"png"});e.subscribe(function(a){b.currentGrid&&b.rootObject.remove(b.currentGrid);var c=new ROS3D.OccupancyGrid({message:a});b.currentGrid=b.tfClient?new ROS3D.SceneNode({frameID:a.header.frame_id,tfClient:b.tfClient,object:c,pose:a.info.origin}):c,b.rootObject.add(b.currentGrid),b.emit("change"),b.continuous||e.unsubscribe()})},ROS3D.OccupancyGridClient.prototype.__proto__=EventEmitter2.prototype,ROS3D.Marker=function(a){a=a||{};var b=a.path||"/",c=a.message,d=a.loader||ROS3D.COLLADA_LOADER_2;"/"!==b.substr(b.length-1)&&(b+="/"),THREE.Object3D.call(this),this.setPose(c.pose);var e=ROS3D.makeColorMaterial(c.color.r,c.color.g,c.color.b,c.color.a);switch(c.type){case ROS3D.MARKER_ARROW:var f,g=c.scale.x,h=.23*g,i=c.scale.y,j=.5*i,k=null;if(2===c.points.length){k=new THREE.Vector3(c.points[0].x,c.points[0].y,c.points[0].z);var l=new THREE.Vector3(c.points[1].x,c.points[1].y,c.points[1].z);f=k.clone().negate().add(l),g=f.length(),i=c.scale.y,j=c.scale.x,0!==c.scale.z&&(h=c.scale.z)}this.add(new ROS3D.Arrow({direction:f,origin:k,length:g,headLength:h,shaftDiameter:j,headDiameter:i,material:e}));break;case ROS3D.MARKER_CUBE:var m=new THREE.CubeGeometry(c.scale.x,c.scale.y,c.scale.z);this.add(new THREE.Mesh(m,e));break;case ROS3D.MARKER_SPHERE:var n=new THREE.SphereGeometry(.5),o=new THREE.Mesh(n,e);o.scale.x=c.scale.x,o.scale.y=c.scale.y,o.scale.z=c.scale.z,this.add(o);break;case ROS3D.MARKER_CYLINDER:var p=new THREE.CylinderGeometry(.5,.5,1,16,1,!1),q=new THREE.Mesh(p,e);q.quaternion.setFromAxisAngle(new THREE.Vector3(1,0,0),.5*Math.PI),q.scale=new THREE.Vector3(c.scale.x,c.scale.z,c.scale.y),this.add(q);break;case ROS3D.MARKER_LINE_STRIP:var r,s=new THREE.Geometry,t=new THREE.LineBasicMaterial({size:c.scale.x});for(r=0;r<c.points.length;r++){var u=new THREE.Vector3;u.x=c.points[r].x,u.y=c.points[r].y,u.z=c.points[r].z,s.vertices.push(u)}if(c.colors.length===c.points.length)for(t.vertexColors=!0,r=0;r<c.points.length;r++){var v=new THREE.Color;v.setRGB(c.colors[r].r,c.colors[r].g,c.colors[r].b),s.colors.push(v)}else t.color.setRGB(c.color.r,c.color.g,c.color.b);this.add(new THREE.Line(s,t));break;case ROS3D.MARKER_LINE_LIST:var w,x=new THREE.Geometry,y=new THREE.LineBasicMaterial({size:c.scale.x});for(w=0;w<c.points.length;w++){var z=new THREE.Vector3;z.x=c.points[w].x,z.y=c.points[w].y,z.z=c.points[w].z,x.vertices.push(z)}if(c.colors.length===c.points.length)for(y.vertexColors=!0,w=0;w<c.points.length;w++){var A=new THREE.Color;A.setRGB(c.colors[w].r,c.colors[w].g,c.colors[w].b),x.colors.push(A)}else y.color.setRGB(c.color.r,c.color.g,c.color.b);this.add(new THREE.Line(x,y,THREE.LinePieces));break;case ROS3D.MARKER_CUBE_LIST:var B,C,D,E,F=new THREE.Object3D,G=c.points.length,H=G===c.colors.length,I=Math.ceil(G/1250);for(B=0;G>B;B+=I)C=new THREE.CubeGeometry(c.scale.x,c.scale.y,c.scale.z),D=H?ROS3D.makeColorMaterial(c.colors[B].r,c.colors[B].g,c.colors[B].b,c.colors[B].a):e,E=new THREE.Mesh(C,D),E.position.x=c.points[B].x,E.position.y=c.points[B].y,E.position.z=c.points[B].z,F.add(E);this.add(F);break;case ROS3D.MARKER_SPHERE_LIST:case ROS3D.MARKER_POINTS:var J,K=new THREE.Geometry,L=new THREE.ParticleBasicMaterial({size:c.scale.x});for(J=0;J<c.points.length;J++){var M=new THREE.Vector3;M.x=c.points[J].x,M.y=c.points[J].y,M.z=c.points[J].z,K.vertices.push(M)}if(c.colors.length===c.points.length)for(L.vertexColors=!0,J=0;J<c.points.length;J++){var N=new THREE.Color;N.setRGB(c.colors[J].r,c.colors[J].g,c.colors[J].b),K.colors.push(N)}else L.color.setRGB(c.color.r,c.color.g,c.color.b);this.add(new THREE.ParticleSystem(K,L));break;case ROS3D.MARKER_TEXT_VIEW_FACING:if(c.text.length>0){var O=new THREE.TextGeometry(c.text,{size:.5*c.scale.x,height:.1*c.scale.x,curveSegments:4,font:"helvetiker",bevelEnabled:!1,bevelThickness:2,bevelSize:2,material:0,extrudeMaterial:0});O.computeVertexNormals(),O.computeBoundingBox();var P=new THREE.Mesh(O,e),Q=-.5*(O.boundingBox.max.x-O.boundingBox.min.x);P.position.y=-Q,P.rotation.x=.5*Math.PI,P.rotation.y=1.5*Math.PI,this.add(P)}break;case ROS3D.MARKER_MESH_RESOURCE:var R=null;(0!==c.color.r||0!==c.color.g||0!==c.color.b||0!==c.color.a)&&(R=e);var S=new ROS3D.MeshResource({path:b,resource:c.mesh_resource.substr(10),material:R,loader:d});this.add(S);break;case ROS3D.MARKER_TRIANGLE_LIST:var T=new ROS3D.TriangleList({material:e,vertices:c.points,colors:c.colors});T.scale=new THREE.Vector3(c.scale.x,c.scale.y,c.scale.z),this.add(T);break;default:console.error("Currently unsupported marker type: "+c.type)}},ROS3D.Marker.prototype.__proto__=THREE.Object3D.prototype,ROS3D.Marker.prototype.setPose=function(a){this.position.x=a.position.x,this.position.y=a.position.y,this.position.z=a.position.z,this.quaternion=new THREE.Quaternion(a.orientation.x,a.orientation.y,a.orientation.z,a.orientation.w),this.quaternion.normalize(),this.updateMatrixWorld()
},ROS3D.Marker.prototype.dispose=function(){this.children.forEach(function(a){a instanceof ROS3D.MeshResource?a.children.forEach(function(b){void 0!==b.material&&b.material.dispose(),b.children.forEach(function(a){void 0!==a.geometry&&a.geometry.dispose(),void 0!==a.material&&a.material.dispose(),b.remove(a)}),a.remove(b)}):(void 0!==a.geometry&&a.geometry.dispose(),void 0!==a.material&&a.material.dispose()),a.parent.remove(a)})},ROS3D.MarkerArrayClient=function(a){var b=this;a=a||{};var c=a.ros,d=a.topic;this.tfClient=a.tfClient,this.rootObject=a.rootObject||new THREE.Object3D,this.path=a.path||"/",this.loader=a.loader||ROS3D.COLLADA_LOADER_2,this.markers={};var e=new ROSLIB.Topic({ros:c,name:d,messageType:"visualization_msgs/MarkerArray",compression:"png"});e.subscribe(function(a){a.markers.forEach(function(a){var c=new ROS3D.Marker({message:a,path:b.path,loader:b.loader});b.rootObject.remove(b.markers[a.ns+a.id]),b.markers[a.ns+a.id]=new ROS3D.SceneNode({frameID:a.header.frame_id,tfClient:b.tfClient,object:c}),b.rootObject.add(b.markers[a.ns+a.id])}),b.emit("change")})},ROS3D.MarkerArrayClient.prototype.__proto__=EventEmitter2.prototype,ROS3D.MarkerClient=function(a){var b=this;a=a||{};var c=a.ros,d=a.topic;this.tfClient=a.tfClient,this.rootObject=a.rootObject||new THREE.Object3D,this.path=a.path||"/",this.loader=a.loader||ROS3D.COLLADA_LOADER_2,this.markers={};var e=new ROSLIB.Topic({ros:c,name:d,messageType:"visualization_msgs/Marker",compression:"png"});e.subscribe(function(a){var c=new ROS3D.Marker({message:a,path:b.path,loader:b.loader});b.rootObject.remove(b.markers[a.ns+a.id]),b.markers[a.ns+a.id]=new ROS3D.SceneNode({frameID:a.header.frame_id,tfClient:b.tfClient,object:c}),b.rootObject.add(b.markers[a.ns+a.id]),b.emit("change")})},ROS3D.MarkerClient.prototype.__proto__=EventEmitter2.prototype,ROS3D.Arrow=function(a){a=a||{};var b=a.origin||new THREE.Vector3(0,0,0),c=a.direction||new THREE.Vector3(1,0,0),d=a.length||1,e=a.headLength||.2,f=a.shaftDiameter||.05,g=a.headDiameter||.1,h=a.material||new THREE.MeshBasicMaterial,i=d-e,j=new THREE.CylinderGeometry(.5*f,.5*f,i,12,1),k=new THREE.Matrix4;k.setPosition(new THREE.Vector3(0,.5*i,0)),j.applyMatrix(k);var l=new THREE.CylinderGeometry(0,.5*g,e,12,1);k.setPosition(new THREE.Vector3(0,i+.5*e,0)),l.applyMatrix(k),THREE.GeometryUtils.merge(j,l),THREE.Mesh.call(this,j,h),this.position=b,this.setDirection(c)},ROS3D.Arrow.prototype.__proto__=THREE.Mesh.prototype,ROS3D.Arrow.prototype.setDirection=function(a){var b=new THREE.Vector3(0,1,0).cross(a),c=Math.acos(new THREE.Vector3(0,1,0).dot(a.clone().normalize()));this.matrix=(new THREE.Matrix4).makeRotationAxis(b.normalize(),c),this.rotation.setFromRotationMatrix(this.matrix,this.rotation.order)},ROS3D.Arrow.prototype.setLength=function(a){this.scale.set(a,a,a)},ROS3D.Arrow.prototype.setColor=function(a){this.line.material.color.setHex(a),this.cone.material.color.setHex(a)},ROS3D.Axes=function(a){function b(a){var b=new THREE.Color;b.setRGB(a.x,a.y,a.z);var d=new THREE.MeshBasicMaterial({color:b.getHex()}),e=new THREE.Vector3;e.crossVectors(a,new THREE.Vector3(0,-1,0));var f=new THREE.Quaternion;f.setFromAxisAngle(e,.5*Math.PI);var g=new THREE.Mesh(c.headGeom,d);g.position=a.clone(),g.position.multiplyScalar(.95),g.quaternion=f,g.updateMatrix(),c.add(g);var h=new THREE.Mesh(c.lineGeom,d);h.position=a.clone(),h.position.multiplyScalar(.45),h.quaternion=f,h.updateMatrix(),c.add(h)}var c=this;a=a||{};var d=a.shaftRadius||.008,e=a.headRadius||.023,f=a.headLength||.1;THREE.Object3D.call(this),this.lineGeom=new THREE.CylinderGeometry(d,d,1-f),this.headGeom=new THREE.CylinderGeometry(0,e,f),b(new THREE.Vector3(1,0,0)),b(new THREE.Vector3(0,1,0)),b(new THREE.Vector3(0,0,1))},ROS3D.Axes.prototype.__proto__=THREE.Object3D.prototype,ROS3D.Grid=function(a){a=a||{};var b=a.size||10,c=a.color||"#cccccc",d=a.lineWidth||1,e=a.cellSize||1;THREE.Object3D.call(this);for(var f=new THREE.LineBasicMaterial({color:c,linewidth:d}),g=0;b>=g;++g){var h=e*b/2,i=h-g*e,j=new THREE.Geometry;j.vertices.push(new THREE.Vector3(-h,i,0),new THREE.Vector3(h,i,0));var k=new THREE.Geometry;k.vertices.push(new THREE.Vector3(i,-h,0),new THREE.Vector3(i,h,0)),this.add(new THREE.Line(j,f)),this.add(new THREE.Line(k,f))}},ROS3D.Grid.prototype.__proto__=THREE.Object3D.prototype,ROS3D.MeshResource=function(a){var b=this;a=a||{};var c=a.path||"/",d=a.resource,e=a.material||null;this.warnings=a.warnings;var f=a.loader||ROS3D.COLLADA_LOADER_2;THREE.Object3D.call(this),"/"!==c.substr(c.length-1)&&(this.path+="/");var g,h=c+d,i=h.substr(-4).toLowerCase();".dae"===i?(g=f===ROS3D.COLLADA_LOADER?new THREE.ColladaLoader:new ColladaLoader2,g.log=function(a){b.warnings&&console.warn(a)},g.load(h,function(a){if(f===ROS3D.COLLADA_LOADER_2&&a.dae.asset.unit){var c=a.dae.asset.unit;a.scene.scale=new THREE.Vector3(c,c,c)}if(null!==e){var d=function(a,b){if(a.material=b,a.children)for(var c=0;c<a.children.length;c++)d(a.children[c],b)};d(a.scene,e)}b.add(a.scene)})):".stl"===i&&(g=new THREE.STLLoader,g.addEventListener("error",function(a){b.warnings&&console.warn(a.message)}),g.addEventListener("load",function(a){var c=a.content;c.computeFaceNormals();var d;d=null!==e?new THREE.Mesh(c,e):new THREE.Mesh(c,new THREE.MeshBasicMaterial({color:10066329})),b.add(d)}),g.load(h))},ROS3D.MeshResource.prototype.__proto__=THREE.Object3D.prototype,ROS3D.TriangleList=function(a){a=a||{};var b=a.material||new THREE.MeshBasicMaterial,c=a.vertices,d=a.colors;THREE.Object3D.call(this),b.side=THREE.DoubleSide;var e=new THREE.Geometry;for(f=0;f<c.length;f++)e.vertices.push(new THREE.Vector3(c[f].x,c[f].y,c[f].z));var f,g;if(d.length===c.length){for(f=0;f<c.length;f+=3){var h=new THREE.Face3(f,f+1,f+2);for(g=3*f;3*f+3>g;f++){var i=new THREE.Color;i.setRGB(d[f].r,d[f].g,d[f].b),h.vertexColors.push(i)}e.faces.push(k)}b.vertexColors=THREE.VertexColors}else if(d.length===c.length/3){for(f=0;f<c.length;f+=3){var j=new THREE.Face3(f,f+1,f+2);j.color.setRGB(d[f/3].r,d[f/3].g,d[f/3].b),e.faces.push(j)}b.vertexColors=THREE.FaceColors}else for(f=0;f<c.length;f+=3){var k=new THREE.Face3(f,f+1,f+2);e.faces.push(k)}e.computeBoundingBox(),e.computeBoundingSphere(),e.computeCentroids(),e.computeFaceNormals(),this.add(new THREE.Mesh(e,b))},ROS3D.TriangleList.prototype.__proto__=THREE.Object3D.prototype,ROS3D.TriangleList.prototype.setColor=function(a){this.mesh.material.color.setHex(a)},ROS3D.Urdf=function(a){a=a||{};var b=a.urdfModel,c=a.path||"/",d=a.tfClient,e=a.tfPrefix||"",f=a.loader||ROS3D.COLLADA_LOADER_2;THREE.Object3D.call(this);var g=b.links;for(var h in g){var i=g[h];if(i.visual&&i.visual.geometry){var j=e+"/"+i.name,k=null;if(i.visual.material&&i.visual.material.color){var l=i.visual.material&&i.visual.material.color;k=ROS3D.makeColorMaterial(l.r,l.g,l.b,l.a)}if(i.visual.geometry.type===ROSLIB.URDF_MESH){var m=i.visual.geometry.filename,n=m.substr(-4).toLowerCase();if(".dae"===n||".stl"===n){var o=new ROS3D.MeshResource({path:c,resource:m.substring(10),loader:f,material:k});i.visual.geometry.scale&&(o.scale=new THREE.Vector3(i.visual.geometry.scale.x,i.visual.geometry.scale.y,i.visual.geometry.scale.z));var p=new ROS3D.SceneNode({frameID:j,pose:i.visual.origin,tfClient:d,object:o});this.add(p)}else console.warn("Could not load geometry mesh: "+m)}else{k||(k=ROS3D.makeColorMaterial(0,0,0,1));var q;switch(i.visual.geometry.type){case ROSLIB.URDF_BOX:var r=i.visual.geometry.dimension,s=new THREE.CubeGeometry(r.x,r.y,r.z);q=new THREE.Mesh(s,k);break;case ROSLIB.URDF_CYLINDER:var t=i.visual.geometry.radius,u=i.visual.geometry.length,v=new THREE.CylinderGeometry(t,t,u,16,1,!1);q=new THREE.Mesh(v,k),q.quaternion.setFromAxisAngle(new THREE.Vector3(1,0,0),.5*Math.PI);break;case ROSLIB.URDF_SPHERE:var w=new THREE.SphereGeometry(i.visual.geometry.radius,16);q=new THREE.Mesh(w,k)}var x=new ROS3D.SceneNode({frameID:j,pose:i.visual.origin,tfClient:d,object:q});this.add(x)}}}},ROS3D.Urdf.prototype.__proto__=THREE.Object3D.prototype,ROS3D.UrdfClient=function(a){var b=this;a=a||{};var c=a.ros,d=a.param||"robot_description";this.path=a.path||"/",this.tfClient=a.tfClient,this.rootObject=a.rootObject||new THREE.Object3D;var e=a.tfPrefix||"",f=a.loader||ROS3D.COLLADA_LOADER_2,g=new ROSLIB.Param({ros:c,name:d});g.get(function(a){var c=new ROSLIB.UrdfModel({string:a});b.rootObject.add(new ROS3D.Urdf({urdfModel:c,path:b.path,tfClient:b.tfClient,tfPrefix:e,loader:f}))})},ROS3D.SceneNode=function(a){a=a||{};var b=this,c=a.tfClient,d=a.frameID,e=a.object;this.pose=a.pose||new ROSLIB.Pose,THREE.Object3D.call(this),this.add(e),this.updatePose(this.pose),c.subscribe(d,function(a){var c=new ROSLIB.Transform(a),d=new ROSLIB.Pose(b.pose);d.applyTransform(c),b.updatePose(d)})},ROS3D.SceneNode.prototype.__proto__=THREE.Object3D.prototype,ROS3D.SceneNode.prototype.updatePose=function(a){this.position.x=a.position.x,this.position.y=a.position.y,this.position.z=a.position.z,this.quaternion=new THREE.Quaternion(a.orientation.x,a.orientation.y,a.orientation.z,a.orientation.w),this.updateMatrixWorld(!0)},ROS3D.Viewer=function(a){function b(){c.cameraControls.update(),c.directionalLight.position=c.camera.localToWorld(new THREE.Vector3(-1,1,0)),c.directionalLight.position.normalize(),c.renderer.clear(!0,!0,!0),c.renderer.render(c.scene,c.camera),c.highlighter.renderHighlight(c.renderer,c.scene,c.camera),requestAnimationFrame(b)}var c=this;a=a||{};var d=a.divID,e=a.width,f=a.height,g=a.background||"#111111",h=a.antialias,i=a.intensity||.66,j=a.cameraPose||{x:3,y:3,z:3};this.renderer=new THREE.WebGLRenderer({antialias:h}),this.renderer.setClearColor(parseInt(g.replace("#","0x"),16),1),this.renderer.sortObjects=!1,this.renderer.setSize(e,f),this.renderer.shadowMapEnabled=!1,this.renderer.autoClear=!1,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(40,e/f,.01,1e3),this.camera.position.x=j.x,this.camera.position.y=j.y,this.camera.position.z=j.z,this.cameraControls=new ROS3D.OrbitControls({scene:this.scene,camera:this.camera}),this.cameraControls.userZoomSpeed=.5,this.scene.add(new THREE.AmbientLight(5592405)),this.directionalLight=new THREE.DirectionalLight(16777215,i),this.scene.add(this.directionalLight),this.selectableObjects=new THREE.Object3D,this.scene.add(this.selectableObjects);var k=new ROS3D.MouseHandler({renderer:this.renderer,camera:this.camera,rootObject:this.selectableObjects,fallbackTarget:this.cameraControls});this.highlighter=new ROS3D.Highlighter({mouseHandler:k}),document.getElementById(d).appendChild(this.renderer.domElement),b()},ROS3D.Viewer.prototype.addObject=function(a,b){b?this.selectableObjects.add(a):this.scene.add(a)},ROS3D.Highlighter=function(a){a=a||{};var b=a.mouseHandler;this.hoverObjs=[],b.addEventListener("mouseover",this.onMouseOver.bind(this)),b.addEventListener("mouseout",this.onMouseOut.bind(this))},ROS3D.Highlighter.prototype.onMouseOver=function(a){this.hoverObjs.push(a.currentTarget)},ROS3D.Highlighter.prototype.onMouseOut=function(a){this.hoverObjs.splice(this.hoverObjs.indexOf(a.currentTarget),1)},ROS3D.Highlighter.prototype.getWebglObjects=function(a,b,c){for(var d=a.__webglObjects,e=0;e<b.length;e++)if(b[e]){for(var f=d.length-1;f>=0;f--)if(d[f].object===b[e]){c.push(d[f]);break}this.getWebglObjects(a,b[e].children,c)}},ROS3D.Highlighter.prototype.renderHighlight=function(a,b,c){var d=[];this.getWebglObjects(b,this.hoverObjs,d),b.overrideMaterial=new THREE.MeshBasicMaterial({fog:!1,opacity:.5,depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetUnits:-1,side:THREE.DoubleSide});var e=b.__webglObjects;b.__webglObjects=d,a.render(b,c),b.__webglObjects=e,b.overrideMaterial=null},ROS3D.MouseHandler=function(a){THREE.EventDispatcher.call(this),this.renderer=a.renderer,this.camera=a.camera,this.rootObject=a.rootObject,this.fallbackTarget=a.fallbackTarget,this.lastTarget=this.fallbackTarget,this.dragging=!1,this.projector=new THREE.Projector;var b=["contextmenu","click","dblclick","mouseout","mousedown","mouseup","mousemove","mousewheel","DOMMouseScroll","touchstart","touchend","touchcancel","touchleave","touchmove"];this.listeners={},b.forEach(function(a){this.listeners[a]=this.processDomEvent.bind(this),this.renderer.domElement.addEventListener(a,this.listeners[a],!1)},this)},ROS3D.MouseHandler.prototype.processDomEvent=function(a){a.preventDefault();var b,c,d=a.target,e=d.getBoundingClientRect();-1!==a.type.indexOf("touch")?(b=a.changedTouches[0].clientX,c=a.changedTouches[0].clientY):(b=a.clientX,c=a.clientY);var f=b-e.left-d.clientLeft+d.scrollLeft,g=c-e.top-d.clientTop+d.scrollTop,h=f/d.clientWidth*2-1,i=-g/d.clientHeight*2+1,j=new THREE.Vector3(h,i,.5);this.projector.unprojectVector(j,this.camera);var k=new THREE.Raycaster(this.camera.position.clone(),j.sub(this.camera.position).normalize());k.linePrecision=.001;var l=k.ray,m={mousePos:new THREE.Vector2(h,i),mouseRay:l,domEvent:a,camera:this.camera,intersection:this.lastIntersection};if("mouseout"===a.type)return this.dragging&&(this.notify(this.lastTarget,"mouseup",m),this.dragging=!1),this.notify(this.lastTarget,"mouseout",m),void(this.lastTarget=null);if("touchleave"===a.type||"touchend"===a.type)return this.dragging&&(this.notify(this.lastTarget,"mouseup",m),this.dragging=!1),this.notify(this.lastTarget,"touchend",m),void(this.lastTarget=null);if(this.dragging)return this.notify(this.lastTarget,a.type,m),void(("mouseup"===a.type&&2===a.button||"click"===a.type||"touchend"===a.type)&&(this.dragging=!1));d=this.lastTarget;var n=[];if(n=k.intersectObject(this.rootObject,!0),n.length>0?(d=n[0].object,m.intersection=this.lastIntersection=n[0]):d=this.fallbackTarget,d!==this.lastTarget&&a.type.match(/mouse/)){var o=this.notify(d,"mouseover",m);o?this.notify(this.lastTarget,"mouseout",m):(d=this.fallbackTarget,d!==this.lastTarget&&(this.notify(d,"mouseover",m),this.notify(this.lastTarget,"mouseout",m)))}if(d!==this.lastTarget&&a.type.match(/touch/)){var p=this.notify(d,a.type,m);p?(this.notify(this.lastTarget,"touchleave",m),this.notify(this.lastTarget,"touchend",m)):(d=this.fallbackTarget,d!==this.lastTarget&&(this.notify(this.lastTarget,"touchmove",m),this.notify(this.lastTarget,"touchend",m)))}this.notify(d,a.type,m),("mousedown"===a.type||"touchstart"===a.type||"touchmove"===a.type)&&(this.dragging=!0),this.lastTarget=d},ROS3D.MouseHandler.prototype.notify=function(a,b,c){for(c.type=b,c.cancelBubble=!1,c.stopPropagation=function(){c.cancelBubble=!0},c.currentTarget=a;c.currentTarget;){if(c.currentTarget.dispatchEvent&&c.currentTarget.dispatchEvent instanceof Function&&(c.currentTarget.dispatchEvent(c),c.cancelBubble))return this.dispatchEvent(c),!0;c.currentTarget=c.currentTarget.parent}return!1},THREE.EventDispatcher.prototype.apply(ROS3D.MouseHandler.prototype),ROS3D.OrbitControls=function(a){function b(a){var b=a.domEvent;switch(b.preventDefault(),b.button){case 0:A=z.ROTATE,n.set(b.clientX,b.clientY);break;case 1:A=z.MOVE,u=new THREE.Vector3(0,0,1);var c=(new THREE.Matrix4).extractRotation(this.camera.matrix);u.applyMatrix4(c),t=j.center.clone(),v=j.camera.position.clone(),w=d(a.mouseRay,t,u);break;case 2:A=z.ZOOM,q.set(b.clientX,b.clientY)}this.showAxes()}function c(a){var b=a.domEvent;if(A===z.ROTATE)o.set(b.clientX,b.clientY),p.subVectors(o,n),j.rotateLeft(2*Math.PI*p.x/l*j.userRotateSpeed),j.rotateUp(2*Math.PI*p.y/l*j.userRotateSpeed),n.copy(o),this.showAxes();else if(A===z.ZOOM)r.set(b.clientX,b.clientY),s.subVectors(r,q),s.y>0?j.zoomIn():j.zoomOut(),q.copy(r),this.showAxes();else if(A===z.MOVE){var c=d(a.mouseRay,j.center,u);if(!c)return;var e=(new THREE.Vector3).subVectors(w.clone(),c.clone());j.center.addVectors(t.clone(),e.clone()),j.camera.position.addVectors(v.clone(),e.clone()),j.update(),j.camera.updateMatrixWorld(),this.showAxes()}}function d(a,b,c){var d=new THREE.Vector3,e=new THREE.Vector3;d.subVectors(b,a.origin);var f=a.direction.dot(c);if(Math.abs(f)<a.precision)return null;var g=c.dot(d)/f;return e=a.direction.clone().multiplyScalar(g)}function e(){j.userRotate&&(A=z.NONE)}function f(a){if(j.userZoom){var b,c=a.domEvent;b="undefined"!=typeof c.wheelDelta?c.wheelDelta:-c.detail,b>0?j.zoomIn():j.zoomOut(),this.showAxes()}}function g(a){var b=a.domEvent;switch(b.touches.length){case 1:A=z.ROTATE,n.set(b.touches[0].pageX-window.scrollX,b.touches[0].pageY-window.scrollY);break;case 2:A=z.NONE,u=new THREE.Vector3(0,0,1);var c=(new THREE.Matrix4).extractRotation(this.camera.matrix);u.applyMatrix4(c),t=j.center.clone(),v=j.camera.position.clone(),w=d(a.mouseRay,t,u),x[0]=new THREE.Vector2(b.touches[0].pageX,b.touches[0].pageY),x[1]=new THREE.Vector2(b.touches[1].pageX,b.touches[1].pageY),y[0]=new THREE.Vector2(0,0),y[1]=new THREE.Vector2(0,0)}this.showAxes(),b.preventDefault()}function h(a){var b=a.domEvent;if(A===z.ROTATE)o.set(b.touches[0].pageX-window.scrollX,b.touches[0].pageY-window.scrollY),p.subVectors(o,n),j.rotateLeft(2*Math.PI*p.x/l*j.userRotateSpeed),j.rotateUp(2*Math.PI*p.y/l*j.userRotateSpeed),n.copy(o),this.showAxes();else{if(y[0].set(x[0].x-b.touches[0].pageX,x[0].y-b.touches[0].pageY),y[1].set(x[1].x-b.touches[1].pageX,x[1].y-b.touches[1].pageY),y[0].lengthSq()>m&&y[1].lengthSq()>m&&(x[0].set(b.touches[0].pageX,b.touches[0].pageY),x[1].set(b.touches[1].pageX,b.touches[1].pageY),y[0].dot(y[1])>0&&A!==z.ZOOM?A=z.MOVE:y[0].dot(y[1])<0&&A!==z.MOVE&&(A=z.ZOOM),A===z.ZOOM)){var c=new THREE.Vector2;c.subVectors(x[0],x[1]),y[0].dot(c)<0&&y[1].dot(c)>0?j.zoomOut():y[0].dot(c)>0&&y[1].dot(c)<0&&j.zoomIn()}if(A===z.MOVE){var e=d(a.mouseRay,j.center,u);if(!e)return;var f=(new THREE.Vector3).subVectors(w.clone(),e.clone());j.center.addVectors(t.clone(),f.clone()),j.camera.position.addVectors(v.clone(),f.clone()),j.update(),j.camera.updateMatrixWorld()}this.showAxes(),b.preventDefault()}}function i(a){var b=a.domEvent;1===b.touches.length&&A!==z.ROTATE&&(A=z.ROTATE,n.set(b.touches[0].pageX-window.scrollX,b.touches[0].pageY-window.scrollY))}THREE.EventDispatcher.call(this);var j=this;a=a||{};var k=a.scene;this.camera=a.camera,this.center=new THREE.Vector3,this.userZoom=!0,this.userZoomSpeed=a.userZoomSpeed||1,this.userRotate=!0,this.userRotateSpeed=a.userRotateSpeed||1,this.autoRotate=a.autoRotate,this.autoRotateSpeed=a.autoRotateSpeed||2,this.camera.up=new THREE.Vector3(0,0,1);var l=1800,m=10,n=new THREE.Vector2,o=new THREE.Vector2,p=new THREE.Vector2,q=new THREE.Vector2,r=new THREE.Vector2,s=new THREE.Vector2,t=new THREE.Vector3,u=new THREE.Vector3,v=new THREE.Vector3,w=new THREE.Vector3,x=new Array(2),y=new Array(2);this.phiDelta=0,this.thetaDelta=0,this.scale=1,this.lastPosition=new THREE.Vector3;var z={NONE:-1,ROTATE:0,ZOOM:1,MOVE:2},A=z.NONE;this.axes=new ROS3D.Axes({shaftRadius:.025,headRadius:.07,headLength:.2}),k.add(this.axes),this.axes.traverse(function(a){a.visible=!1}),this.addEventListener("mousedown",b),this.addEventListener("mouseup",e),this.addEventListener("mousemove",c),this.addEventListener("touchstart",g),this.addEventListener("touchmove",h),this.addEventListener("touchend",i),this.addEventListener("mousewheel",f),this.addEventListener("DOMMouseScroll",f)},ROS3D.OrbitControls.prototype.showAxes=function(){var a=this;this.axes.traverse(function(a){a.visible=!0}),this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(function(){a.axes.traverse(function(a){a.visible=!1}),a.hideTimeout=!1},1e3)},ROS3D.OrbitControls.prototype.rotateLeft=function(a){void 0===a&&(a=2*Math.PI/60/60*this.autoRotateSpeed),this.thetaDelta-=a},ROS3D.OrbitControls.prototype.rotateRight=function(a){void 0===a&&(a=2*Math.PI/60/60*this.autoRotateSpeed),this.thetaDelta+=a},ROS3D.OrbitControls.prototype.rotateUp=function(a){void 0===a&&(a=2*Math.PI/60/60*this.autoRotateSpeed),this.phiDelta-=a},ROS3D.OrbitControls.prototype.rotateDown=function(a){void 0===a&&(a=2*Math.PI/60/60*this.autoRotateSpeed),this.phiDelta+=a},ROS3D.OrbitControls.prototype.zoomIn=function(a){void 0===a&&(a=Math.pow(.95,this.userZoomSpeed)),this.scale/=a},ROS3D.OrbitControls.prototype.zoomOut=function(a){void 0===a&&(a=Math.pow(.95,this.userZoomSpeed)),this.scale*=a},ROS3D.OrbitControls.prototype.update=function(){var a=this.camera.position,b=a.clone().sub(this.center),c=Math.atan2(b.y,b.x),d=Math.atan2(Math.sqrt(b.y*b.y+b.x*b.x),b.z);this.autoRotate&&this.rotateLeft(2*Math.PI/60/60*this.autoRotateSpeed),c+=this.thetaDelta,d+=this.phiDelta;var e=1e-6;d=Math.max(e,Math.min(Math.PI-e,d));var f=b.length();b.y=f*Math.sin(d)*Math.sin(c),b.z=f*Math.cos(d),b.x=f*Math.sin(d)*Math.cos(c),b.multiplyScalar(this.scale),a.copy(this.center).add(b),this.camera.lookAt(this.center),f=b.length(),this.axes.position=this.center.clone(),this.axes.scale.x=this.axes.scale.y=this.axes.scale.z=.05*f,this.axes.updateMatrixWorld(!0),this.thetaDelta=0,this.phiDelta=0,this.scale=1,this.lastPosition.distanceTo(this.camera.position)>0&&(this.dispatchEvent({type:"change"}),this.lastPosition.copy(this.camera.position))},THREE.EventDispatcher.prototype.apply(ROS3D.OrbitControls.prototype);