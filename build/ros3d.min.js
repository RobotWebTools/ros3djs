var ROS3D=ROS3D||{REVISION:"3"};ROS3D.MARKER_ARROW=0;ROS3D.MARKER_CUBE=1;ROS3D.MARKER_SPHERE=2;ROS3D.MARKER_CYLINDER=3;ROS3D.MARKER_LINE_STRIP=4;ROS3D.MARKER_LINE_LIST=5;ROS3D.MARKER_CUBE_LIST=6;ROS3D.MARKER_SPHERE_LIST=7;ROS3D.MARKER_POINTS=8;ROS3D.MARKER_TEXT_VIEW_FACING=9;ROS3D.MARKER_MESH_RESOURCE=10;ROS3D.MARKER_TRIANGLE_LIST=11;ROS3D.INTERACTIVE_MARKER_KEEP_ALIVE=0;ROS3D.INTERACTIVE_MARKER_POSE_UPDATE=1;ROS3D.INTERACTIVE_MARKER_MENU_SELECT=2;ROS3D.INTERACTIVE_MARKER_BUTTON_CLICK=3;ROS3D.INTERACTIVE_MARKER_MOUSE_DOWN=4;ROS3D.INTERACTIVE_MARKER_MOUSE_UP=5;ROS3D.INTERACTIVE_MARKER_NONE=0;ROS3D.INTERACTIVE_MARKER_MENU=1;ROS3D.INTERACTIVE_MARKER_BUTTON=2;ROS3D.INTERACTIVE_MARKER_MOVE_AXIS=3;ROS3D.INTERACTIVE_MARKER_MOVE_PLANE=4;ROS3D.INTERACTIVE_MARKER_ROTATE_AXIS=5;ROS3D.INTERACTIVE_MARKER_MOVE_ROTATE=6;ROS3D.INTERACTIVE_MARKER_INHERIT=0;ROS3D.INTERACTIVE_MARKER_FIXED=1;ROS3D.INTERACTIVE_MARKER_VIEW_FACING=2;ROS3D.makeColorMaterial=function(h,f,c,d){var e=new THREE.Color();e.setRGB(h,f,c);if(d<=0.99){return new THREE.MeshBasicMaterial({color:e.getHex(),opacity:d+0.1,transparent:true,depthWrite:true,blendSrc:THREE.SrcAlphaFactor,blendDst:THREE.OneMinusSrcAlphaFactor,blendEquation:THREE.ReverseSubtractEquation,blending:THREE.NormalBlending})}else{return new THREE.MeshLambertMaterial({color:e.getHex(),opacity:d,blending:THREE.NormalBlending})}};ROS3D.intersectPlane=function(d,a,e){var b=new THREE.Vector3();var c=new THREE.Vector3();b.subVectors(a,d.origin);dot=d.direction.dot(e);if(Math.abs(dot)<d.precision){return undefined}scalar=e.dot(b)/dot;c.addVectors(d.origin,d.direction.clone().multiplyScalar(scalar));return c};ROS3D.findClosestPoint=function(o,n){var g=new THREE.Vector3;g.subVectors(o.origin,n.origin);var e=n.direction.clone();var b=o.direction.clone();var c=g.dot(e);var d=e.dot(b);var a=g.dot(b);var l=e.dot(e);var f=b.dot(b);var k=f*l-d*d;if(Math.abs(k)<=0.0001){return undefined}var h=c*d-a*l;var m=h/k;return m};ROS3D.closestAxisPoint=function(a,k,n){var m=new THREE.Projector();var c=a.origin.clone();m.projectVector(c,k);var g=a.direction.clone().add(a.origin);m.projectVector(g,k);var l=g.clone().sub(c);var h=new THREE.Vector2;var p=h.subVectors(n,c).dot(l)/l.dot(l);var f=new THREE.Vector2;f.addVectors(c,l.clone().multiplyScalar(p));var e=new THREE.Vector3(f.x,f.y,0.5);m.unprojectVector(e,k);var b=new THREE.Ray(k.position,e.sub(k.position).normalize());return ROS3D.findClosestPoint(a,b)};ROS3D.InteractiveMarker=function(a){THREE.Object3D.call(this);THREE.EventDispatcher.call(this);var c=this;var a=a||{};var d=a.handle;this.name=d.name;var b=a.camera;var e=a.path||"/";this.dragging=false;this.onServerSetPose({pose:d.pose});this.dragStart={position:new THREE.Vector3(),orientation:new THREE.Quaternion(),positionWorld:new THREE.Vector3(),orientationWorld:new THREE.Quaternion(),event3d:{}};d.controls.forEach(function(f){c.add(new ROS3D.InteractiveMarkerControl({parent:c,message:f,camera:b,path:e}))});if(d.menuEntries.length>0){this.menu=new ROS3D.InteractiveMarkerMenu({menuEntries:d.menuEntries});this.menu.addEventListener("menu-select",function(f){c.dispatchEvent(f)})}};ROS3D.InteractiveMarker.prototype.__proto__=THREE.Object3D.prototype;ROS3D.InteractiveMarker.prototype.showMenu=function(b,a){if(this.menu){this.menu.show(b,a)}};ROS3D.InteractiveMarker.prototype.moveAxis=function(e,h,f){if(this.dragging){var d=e.currentControlOri;var c=h.clone().applyQuaternion(d);var g=this.dragStart.event3d.intersection.point;var l=c.clone().applyQuaternion(this.dragStart.orientationWorld.clone());var a=new THREE.Ray(g,l);var k=ROS3D.closestAxisPoint(a,f.camera,f.mousePos);var b=new THREE.Vector3;b.addVectors(this.dragStart.position,c.clone().applyQuaternion(this.dragStart.orientation).multiplyScalar(k));this.setPosition(e,b);f.stopPropagation()}};ROS3D.InteractiveMarker.prototype.movePlane=function(d,g,h){if(this.dragging){var c=d.currentControlOri;var f=g.clone().applyQuaternion(c);var k=this.dragStart.event3d.intersection.point;var e=f.clone().applyQuaternion(this.dragStart.orientationWorld);var a=ROS3D.intersectPlane(h.mouseRay,k,e);var b=new THREE.Vector3;b.subVectors(a,k);b.add(this.dragStart.positionWorld);this.setPosition(d,b);h.stopPropagation()}};ROS3D.InteractiveMarker.prototype.rotateAxis=function(l,g,c){if(this.dragging){l.updateMatrixWorld();var q=l.currentControlOri;var e=q.clone().multiply(g.clone());var t=(new THREE.Vector3(1,0,0)).applyQuaternion(e);var n=this.dragStart.event3d.intersection.point;var f=t.applyQuaternion(this.dragStart.orientationWorld);var k=ROS3D.intersectPlane(c.mouseRay,n,f);var b=new THREE.Ray(this.dragStart.positionWorld,f);var d=ROS3D.intersectPlane(b,n,f);var m=this.dragStart.orientationWorld.clone().multiply(e);var p=m.clone().inverse();k.sub(d);k.applyQuaternion(p);var o=this.dragStart.event3d.intersection.point.clone();o.sub(d);o.applyQuaternion(p);var u=Math.atan2(k.y,k.z);var s=Math.atan2(o.y,o.z);var r=s-u;var h=new THREE.Quaternion();h.setFromAxisAngle(t,r);this.setOrientation(l,h.multiply(this.dragStart.orientationWorld));c.stopPropagation()}};ROS3D.InteractiveMarker.prototype.feedbackEvent=function(a,b){this.dispatchEvent({type:a,position:this.position.clone(),orientation:this.quaternion.clone(),controlName:b.name})};ROS3D.InteractiveMarker.prototype.startDrag=function(b,a){if(a.domEvent.button===0){a.stopPropagation();this.dragging=true;this.updateMatrixWorld(true);var c=new THREE.Vector3();this.matrixWorld.decompose(this.dragStart.positionWorld,this.dragStart.orientationWorld,c);this.dragStart.position=this.position.clone();this.dragStart.orientation=this.quaternion.clone();this.dragStart.event3d=a;this.feedbackEvent("user-mousedown",b)}};ROS3D.InteractiveMarker.prototype.stopDrag=function(b,a){if(a.domEvent.button===0){a.stopPropagation();this.dragging=false;this.dragStart.event3d={};this.onServerSetPose(this.bufferedPoseEvent);this.bufferedPoseEvent=undefined;this.feedbackEvent("user-mouseup",b)}};ROS3D.InteractiveMarker.prototype.buttonClick=function(b,a){a.stopPropagation();this.feedbackEvent("user-button-click",b)};ROS3D.InteractiveMarker.prototype.setPosition=function(b,a){this.position=a;this.feedbackEvent("user-pose-change",b)};ROS3D.InteractiveMarker.prototype.setOrientation=function(b,a){a.normalize();this.quaternion=a;this.feedbackEvent("user-pose-change",b)};ROS3D.InteractiveMarker.prototype.onServerSetPose=function(a){if(a!==undefined){if(this.dragging){this.bufferedPoseEvent=a}else{var b=a.pose;this.position.x=b.position.x;this.position.y=b.position.y;this.position.z=b.position.z;this.useQuaternion=true;this.quaternion=new THREE.Quaternion(b.orientation.x,b.orientation.y,b.orientation.z,b.orientation.w);this.updateMatrixWorld(true)}}};ROS3D.InteractiveMarkerClient=function(a){var b=this;var a=a||{};this.ros=a.ros;this.tfClient=a.tfClient;this.topic=a.topic;this.path=a.path||"/";this.camera=a.camera;this.rootObject=a.rootObject||new THREE.Object3D();this.interactiveMarkers={};this.updateTopic=null;this.feedbackTopic=null;if(this.topic){this.subscribe(this.topic)}};ROS3D.InteractiveMarkerClient.prototype.subscribe=function(a){this.unsubscribe();this.updateTopic=new ROSLIB.Topic({ros:this.ros,name:a+"/tunneled/update",messageType:"visualization_msgs/InteractiveMarkerUpdate",compression:"png"});this.updateTopic.subscribe(this.processUpdate.bind(this));this.feedbackTopic=new ROSLIB.Topic({ros:this.ros,name:a+"/feedback",messageType:"visualization_msgs/InteractiveMarkerFeedback",compression:"png"});this.feedbackTopic.advertise();this.initService=new ROSLIB.Service({ros:this.ros,name:a+"/tunneled/get_init",serviceType:"demo_interactive_markers/GetInit"});var b=new ROSLIB.ServiceRequest({});this.initService.callService(b,this.processInit.bind(this))};ROS3D.InteractiveMarkerClient.prototype.unsubscribe=function(){if(this.updateTopic){this.updateTopic.unsubscribe()}if(this.feedbackTopic){this.feedbackTopic.unadvertise()}for(intMarkerName in this.interactiveMarkers){this.eraseIntMarker(intMarkerName)}this.interactiveMarkers={}};ROS3D.InteractiveMarkerClient.prototype.processInit=function(b){var a=b.msg;a.erases=[];for(intMarkerName in this.interactiveMarkers){a.erases.push(intMarkerName)}a.poses=[];this.processUpdate(a)};ROS3D.InteractiveMarkerClient.prototype.processUpdate=function(b){var a=this;b.erases.forEach(function(d){var c=a.interactiveMarkers[d];a.eraseIntMarker(d)});b.poses.forEach(function(d){var c=a.interactiveMarkers[d.name];if(c){c.setPoseFromServer(d.pose)}});b.markers.forEach(function(f){var e=a.interactiveMarkers[f.name];if(e){a.eraseIntMarker(e.name)}var d=new ROS3D.InteractiveMarkerHandle({message:f,feedbackTopic:a.feedbackTopic,tfClient:a.tfClient});a.interactiveMarkers[f.name]=d;var c=new ROS3D.InteractiveMarker({handle:d,camera:a.camera,path:a.path});a.rootObject.add(c);d.on("pose",function(g){c.onServerSetPose({pose:g})});c.addEventListener("user-pose-change",d.setPoseFromClient.bind(d));c.addEventListener("user-mousedown",d.onMouseDown.bind(d));c.addEventListener("user-mouseup",d.onMouseUp.bind(d));c.addEventListener("user-button-click",d.onButtonClick.bind(d));c.addEventListener("menu-select",d.onMenuSelect.bind(d));d.subscribeTf()})};ROS3D.InteractiveMarkerClient.prototype.eraseIntMarker=function(a){if(this.interactiveMarkers[a]){delete this.interactiveMarkers[a]}};ROS3D.InteractiveMarkerControl=function(k){var e=this;THREE.Object3D.call(this);THREE.EventDispatcher.call(this);var k=k||{};this.parent=k.parent;var h=k.message;this.name=h.name;this.camera=k.camera;this.path=k.path||"/";this.dragging=false;var a=new THREE.Quaternion(h.orientation.x,h.orientation.y,h.orientation.z,h.orientation.w);a.normalize();var f=new THREE.Vector3(1,0,0);f.applyQuaternion(a);this.currentControlOri=new THREE.Quaternion();switch(h.interaction_mode){case ROS3D.INTERACTIVE_MARKER_MOVE_AXIS:this.addEventListener("mousemove",this.parent.moveAxis.bind(this.parent,this,f));this.addEventListener("touchmove",this.parent.moveAxis.bind(this.parent,this,f));break;case ROS3D.INTERACTIVE_MARKER_ROTATE_AXIS:this.addEventListener("mousemove",this.parent.rotateAxis.bind(this.parent,this,a));break;case ROS3D.INTERACTIVE_MARKER_MOVE_PLANE:this.addEventListener("mousemove",this.parent.movePlane.bind(this.parent,this,f));break;case ROS3D.INTERACTIVE_MARKER_BUTTON:this.addEventListener("click",this.parent.buttonClick.bind(this.parent,this));break;default:break}function g(l){l.stopPropagation()}if(h.interaction_mode!=ROS3D.INTERACTIVE_MARKER_NONE){this.addEventListener("mousedown",this.parent.startDrag.bind(this.parent,this));this.addEventListener("mouseup",this.parent.stopDrag.bind(this.parent,this));this.addEventListener("contextmenu",this.parent.showMenu.bind(this.parent,this));this.addEventListener("mouseover",g);this.addEventListener("mouseout",g);this.addEventListener("click",g);this.addEventListener("touchstart",function(l){console.log(l.domEvent);if(l.domEvent.touches.length==1){l.type="mousedown";l.domEvent.button=0;e.dispatchEvent(l)}});this.addEventListener("touchmove",function(l){if(l.domEvent.touches.length==1){console.log(l.domEvent);l.type="mousemove";l.domEvent.button=0;e.dispatchEvent(l)}});this.addEventListener("touchend",function(l){if(l.domEvent.touches.length==0){l.domEvent.button=0;l.type="mouseup";e.dispatchEvent(l);l.type="click";e.dispatchEvent(l)}})}var d=new THREE.Quaternion();var b=this.parent.position.clone().multiplyScalar(-1);switch(h.orientation_mode){case ROS3D.INTERACTIVE_MARKER_INHERIT:d=this.parent.quaternion.clone().inverse();this.updateMatrixWorld=function(l){ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(e,l);e.currentControlOri.copy(e.quaternion);e.currentControlOri.normalize()};break;case ROS3D.INTERACTIVE_MARKER_FIXED:this.updateMatrixWorld=function(l){e.useQuaternion=true;e.quaternion=e.parent.quaternion.clone().inverse();e.updateMatrix();e.matrixWorldNeedsUpdate=true;ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(e,l);e.currentControlOri.copy(e.quaternion)};break;case ROS3D.INTERACTIVE_MARKER_VIEW_FACING:var c=h.independentMarkerOrientation;this.updateMatrixWorld=function(n){e.camera.updateMatrixWorld();var q=new THREE.Matrix4().extractRotation(e.camera.matrixWorld);var o=new THREE.Matrix4();var m=Math.PI*0.5;var p=new THREE.Vector3(-m,0,m);o.setRotationFromEuler(p);var l=new THREE.Matrix4();l.getInverse(e.parent.matrixWorld);q.multiplyMatrices(q,o);q.multiplyMatrices(l,q);e.currentControlOri.setFromRotationMatrix(q);if(!c){e.useQuaternion=true;e.quaternion.copy(e.currentControlOri);e.updateMatrix();e.matrixWorldNeedsUpdate=true}ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(e,n)};break;default:console.error("Unkown orientation mode: "+h.orientation_mode);break}h.markers.forEach(function(m){var l=new ROS3D.Marker({message:m,path:e.path});if(m.header.frame_id!==""){l.position.add(b);l.position.applyQuaternion(d);l.quaternion.multiplyQuaternions(d,l.quaternion);l.updateMatrixWorld()}e.add(l)})};ROS3D.InteractiveMarkerControl.prototype.__proto__=THREE.Object3D.prototype;ROS3D.InteractiveMarkerHandle=function(a){var a=a||{};this.message=a.message;this.feedbackTopic=a.feedbackTopic;this.tfClient=a.tfClient;this.name=this.message.name;this.header=this.message.header;this.controls=this.message.controls;this.menuEntries=this.message.menu_entries;this.dragging=false;this.timeoutHandle=null;this.tfTransform=new ROSLIB.Transform();this.pose=new ROSLIB.Pose();this.setPoseFromServer(this.message.pose)};ROS3D.InteractiveMarkerHandle.prototype.__proto__=EventEmitter2.prototype;ROS3D.InteractiveMarkerHandle.prototype.subscribeTf=function(){if(this.message.header.stamp.secs===0&&this.message.header.stamp.nsecs===0){this.tfClient.subscribe(this.message.header.frame_id,this.tfUpdate.bind(this))}};ROS3D.InteractiveMarkerHandle.prototype.emitServerPoseUpdate=function(){var a=new ROSLIB.Pose(this.pose);a.applyTransform(this.tfTransform);this.emit("pose",a)};ROS3D.InteractiveMarkerHandle.prototype.setPoseFromServer=function(a){this.pose=new ROSLIB.Pose(a);this.emitServerPoseUpdate()};ROS3D.InteractiveMarkerHandle.prototype.tfUpdate=function(a){this.tfTransform=new ROSLIB.Transform(a);this.emitServerPoseUpdate()};ROS3D.InteractiveMarkerHandle.prototype.setPoseFromClient=function(b){this.pose=new ROSLIB.Pose(b);var a=this.tfTransform.clone();a.rotation.invert();this.pose.applyTransform(a);this.sendFeedback(ROS3D.INTERACTIVE_MARKER_POSE_UPDATE,undefined,0,b.controlName);if(this.dragging){if(this.timeoutHandle){clearTimeout(this.timeoutHandle)}this.timeoutHandle=setTimeout(this.setPoseFromClient.bind(this,b),250)}};ROS3D.InteractiveMarkerHandle.prototype.onButtonClick=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_BUTTON_CLICK,a.clickPosition,0,a.controlName)};ROS3D.InteractiveMarkerHandle.prototype.onMouseDown=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MOUSE_DOWN,a.clickPosition,0,a.controlName);this.dragging=true};ROS3D.InteractiveMarkerHandle.prototype.onMouseUp=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MOUSE_UP,a.clickPosition,0,a.controlName);this.dragging=false;if(this.timeoutHandle){clearTimeout(this.timeoutHandle)}};ROS3D.InteractiveMarkerHandle.prototype.onMenuSelect=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MENU_SELECT,undefined,a.id,a.controlName)};ROS3D.InteractiveMarkerHandle.prototype.sendFeedback=function(c,d,e,f){var b=d!==undefined;var d=d||{x:0,y:0,z:0};var a={header:this.header,client_id:this.clientID,marker_name:this.name,control_name:f,event_type:c,pose:this.pose,mouse_point:d,mouse_point_valid:b,menu_entry_id:e};this.feedbackTopic.publish(a)};ROS3D.InteractiveMarkerMenu=function(q){var g=this;var q=q||{};var f=q.menuEntries;var h=q.className||"default-interactive-marker-menu";var p=q.entryClassName||"default-interactive-marker-menu-entry";var o=q.overlayClassName||"default-interactive-marker-overlay";var d=[];d[0]={children:[]};THREE.EventDispatcher.call(this);if(document.getElementById("default-interactive-marker-menu-css")===null){var a=document.createElement("style");a.id="default-interactive-marker-menu-css";a.type="text/css";a.innerHTML=".default-interactive-marker-menu {background-color: #444444;border: 1px solid #888888;border: 1px solid #888888;padding: 0px 0px 0px 0px;color: #FFFFFF;font-family: sans-serif;font-size: 0.8em;z-index: 1002;}.default-interactive-marker-menu ul {padding: 0px 0px 5px 0px;margin: 0px;list-style-type: none;}.default-interactive-marker-menu ul li div {-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;cursor: default;padding: 3px 10px 3px 10px;}.default-interactive-marker-menu-entry:hover {  background-color: #666666;  cursor: pointer;}.default-interactive-marker-menu ul ul {  font-style: italic;  padding-left: 10px;}.default-interactive-marker-overlay {  position: absolute;  top: 0%;  left: 0%;  width: 100%;  height: 100%;  background-color: black;  z-index: 1001;  -moz-opacity: 0.0;  opacity: .0;  filter: alpha(opacity = 0);}";document.getElementsByTagName("head")[0].appendChild(a)}this.menuDomElem=document.createElement("div");this.menuDomElem.style.position="absolute";this.menuDomElem.className=h;this.menuDomElem.addEventListener("contextmenu",function(r){r.preventDefault()});this.overlayDomElem=document.createElement("div");this.overlayDomElem.className=o;this.hideListener=this.hide.bind(this);this.overlayDomElem.addEventListener("contextmenu",this.hideListener);this.overlayDomElem.addEventListener("click",this.hideListener);for(var e=0;e<f.length;e++){var n=f[e];var b=n.id;d[b]={title:n.title,id:b,children:[]}}for(var e=0;e<f.length;e++){var n=f[e];var b=n.id;var c=d[b];var m=d[n.parent_id];m.children.push(c)}function k(s,r){this.dispatchEvent({type:"menu-select",domEvent:r,id:s.id,controlName:this.controlName});this.hide(r)}function l(u,r){var v=document.createElement("ul");u.appendChild(v);var t=r.children;for(var s=0;s<t.length;s++){var x=document.createElement("li");var w=document.createElement("div");w.appendChild(document.createTextNode(t[s].title));v.appendChild(x);x.appendChild(w);if(t[s].children.length>0){l(x,t[s]);w.addEventListener("click",g.hide.bind(g))}else{w.addEventListener("click",k.bind(g,t[s]));w.className="default-interactive-marker-menu-entry"}}}l(this.menuDomElem,d[0])};ROS3D.InteractiveMarkerMenu.prototype.show=function(b,a){if(a&&a.preventDefault){a.preventDefault()}this.controlName=b.name;this.menuDomElem.style.left=a.domEvent.clientX+"px";this.menuDomElem.style.top=a.domEvent.clientY+"px";document.body.appendChild(this.overlayDomElem);document.body.appendChild(this.menuDomElem)};ROS3D.InteractiveMarkerMenu.prototype.hide=function(a){if(a&&a.preventDefault){a.preventDefault()}document.body.removeChild(this.overlayDomElem);document.body.removeChild(this.menuDomElem)};ROS3D.OccupancyGrid=function(p){var p=p||{};var o=p.message;var a=o.info.width;var m=o.info.height;var l=new THREE.PlaneGeometry(a,m);var g=new Uint8Array(a*m*3);for(var n=0;n<m;n++){for(var c=0;c<a;c++){var f=c+((m-n-1)*a);var e=o.data[f];if(e===100){var b=0}else{if(e===0){var b=255}else{var b=127}}var d=(c+(n*a))*3;g[d]=b;g[++d]=b;g[++d]=b}}var k=new THREE.DataTexture(g,a,m,THREE.RGBFormat);k.needsUpdate=true;var h=new THREE.MeshBasicMaterial({map:k});h.side=THREE.DoubleSide;THREE.Mesh.call(this,l,h);this.scale.x=o.info.resolution;this.scale.y=o.info.resolution};ROS3D.OccupancyGrid.prototype.__proto__=THREE.Mesh.prototype;ROS3D.OccupancyGridClient=function(d){var e=this;var d=d||{};var b=d.ros;var c=d.topic||"/map";this.continuous=d.continuous;this.rootObject=d.rootObject||new THREE.Object3D();this.currentGrid=null;var a=new ROSLIB.Topic({ros:b,name:c,messageType:"nav_msgs/OccupancyGrid",compression:"png"});a.subscribe(function(f){if(e.currentGrid){e.rootObject.remove(e.currentGrid)}e.currentGrid=new ROS3D.OccupancyGrid({message:f});e.rootObject.add(e.currentGrid);e.emit("change");if(!e.continuous){a.unsubscribe()}})};ROS3D.OccupancyGridClient.prototype.__proto__=EventEmitter2.prototype;ROS3D.Marker=function(f){var f=f||{};var n=f.path||"/";var k=f.message;if(n.substr(n.length-1)!=="/"){n+="/"}THREE.Object3D.call(this);this.useQuaternion=true;this.setPose(k.pose);var o=ROS3D.makeColorMaterial(k.color.r,k.color.g,k.color.b,k.color.a);switch(k.type){case ROS3D.MARKER_ARROW:var u=k.scale.x;var s=u*0.23;var c=k.scale.y;var l=c*0.5;if(k.points.length===2){var d=new THREE.Vector3(k.points[0].x,k.points[0].y,k.points[0].z);var b=new THREE.Vector3(k.points[1].x,k.points[1].y,k.points[1].z);var w=d.clone().negate().add(b);u=w.length();c=k.scale.y;l=k.scale.x;if(k.scale.z!==0){s=k.scale.z}}this.add(new ROS3D.Arrow({direction:w,origin:d,length:u,headLength:s,shaftDiameter:l,headDiameter:c,material:o}));break;case ROS3D.MARKER_CUBE:var p=new THREE.CubeGeometry(k.scale.x,k.scale.y,k.scale.z);this.add(new THREE.Mesh(p,o));break;case ROS3D.MARKER_SPHERE:var p=new THREE.SphereGeometry(0.5);var a=new THREE.Mesh(p,o);a.scale.x=k.scale.x;a.scale.y=k.scale.y;a.scale.z=k.scale.z;this.add(a);break;case ROS3D.MARKER_CYLINDER:var p=new THREE.CylinderGeometry(0.5,0.5,1,16,1,false);var a=new THREE.Mesh(p,o);a.useQuaternion=true;a.quaternion.setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI*0.5);a.scale=new THREE.Vector3(k.scale.x,k.scale.y,k.scale.z);this.add(a);break;case ROS3D.MARKER_CUBE_LIST:case ROS3D.MARKER_SPHERE_LIST:case ROS3D.MARKER_POINTS:var g=new THREE.Geometry();var m=new THREE.ParticleBasicMaterial({size:k.scale.x});for(var t=0;t<k.points.length;t++){var v=new THREE.Vector3();v.x=k.points[t].x;v.y=k.points[t].y;v.z=k.points[t].z;g.vertices.push(v)}if(k.colors.length===k.points.length){m.vertexColors=true;for(var t=0;t<k.points.length;t++){var q=new THREE.Color();q.setRGB(k.colors[t].r,k.colors[t].g,k.colors[t].b);g.colors.push(q)}}else{m.color.setRGB(k.color.r,k.color.g,k.color.b)}this.add(new THREE.ParticleSystem(g,m));break;case ROS3D.MARKER_TEXT_VIEW_FACING:var h=new THREE.TextGeometry(k.text,{size:k.scale.x*0.5,height:0.1*k.scale.x,curveSegments:4,font:"helvetiker",bevelEnabled:false,bevelThickness:2,bevelSize:2,material:0,extrudeMaterial:0});h.computeVertexNormals();h.computeBoundingBox();var a=new THREE.Mesh(h,o);var e=-0.5*(h.boundingBox.max.x-h.boundingBox.min.x);a.position.y=-e;a.rotation.x=Math.PI*0.5;a.rotation.y=Math.PI*1.5;this.add(a);break;case ROS3D.MARKER_MESH_RESOURCE:this.add(new ROS3D.MeshResource({path:n,resource:k.mesh_resource.substr(10)}));break;case ROS3D.MARKER_TRIANGLE_LIST:var r=new ROS3D.TriangleList({material:o,vertices:k.points,colors:k.colors});r.scale=new THREE.Vector3(k.scale.x,k.scale.y,k.scale.z);this.add(r);break;default:console.error("Currently unsupported marker type: "+k.type);break}};ROS3D.Marker.prototype.__proto__=THREE.Object3D.prototype;ROS3D.Marker.prototype.setPose=function(a){this.position.x=a.position.x;this.position.y=a.position.y;this.position.z=a.position.z;this.quaternion=new THREE.Quaternion(a.orientation.x,a.orientation.y,a.orientation.z,a.orientation.w);this.quaternion.normalize();this.updateMatrixWorld()};ROS3D.MarkerClient=function(d){var e=this;var d=d||{};var b=d.ros;var c=d.topic;this.tfClient=d.tfClient;this.rootObject=d.rootObject||new THREE.Object3D();this.currentMarker=null;var a=new ROSLIB.Topic({ros:b,name:c,messageType:"visualization_msgs/Marker",compression:"png"});a.subscribe(function(g){var f=new ROS3D.Marker({message:g});if(e.currentMarker){e.rootObject.remove(e.currentMarker)}e.currentMarker=new ROS3D.SceneNode({frameID:g.header.frame_id,tfClient:e.tfClient,object:f});e.rootObject.add(e.currentMarker);e.emit("change")})};ROS3D.MarkerClient.prototype.__proto__=EventEmitter2.prototype;ROS3D.Arrow=function(o){var o=o||{};var l=o.origin||new THREE.Vector3(0,0,0);var k=o.direction||new THREE.Vector3(1,0,0);var a=o.length||1;var f=o.headLength||0.2;var c=o.shaftDiameter||0.05;var d=o.headDiameter||0.1;var g=o.material||new THREE.MeshBasicMaterial();var e=a-f;var h=new THREE.CylinderGeometry(c*0.5,c*0.5,e,12,1);var b=new THREE.Matrix4();b.setPosition(new THREE.Vector3(0,e*0.5,0));h.applyMatrix(b);var n=new THREE.CylinderGeometry(0,d*0.5,f,12,1);b.setPosition(new THREE.Vector3(0,e+(f*0.5),0));n.applyMatrix(b);THREE.GeometryUtils.merge(h,n);THREE.Mesh.call(this,h,g);this.position=l;this.setDirection(k)};ROS3D.Arrow.prototype.__proto__=THREE.Mesh.prototype;ROS3D.Arrow.prototype.setDirection=function(c){var a=new THREE.Vector3(0,1,0).cross(c);var b=Math.acos(new THREE.Vector3(0,1,0).dot(c.clone().normalize()));this.matrix=new THREE.Matrix4().makeRotationAxis(a.normalize(),b);this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder)};ROS3D.Arrow.prototype.setLength=function(a){this.scale.set(a,a,a)};ROS3D.Arrow.prototype.setColor=function(a){this.line.material.color.setHex(a);this.cone.material.color.setHex(a)};ROS3D.Axes=function(b){var c=this;var b=b||{};var e=b.shaftRadius||0.008;var d=b.headRadius||0.023;var a=b.headLength||0.1;THREE.Object3D.call(this);this.lineGeom=new THREE.CylinderGeometry(e,e,1-a);this.headGeom=new THREE.CylinderGeometry(0,d,a);function f(m){var k=new THREE.Color();k.setRGB(m.x,m.y,m.z);var l=new THREE.MeshBasicMaterial({color:k.getHex()});var o=new THREE.Vector3;o.crossVectors(m,new THREE.Vector3(0,-1,0));var h=new THREE.Quaternion;h.setFromAxisAngle(o,0.5*Math.PI);var n=new THREE.Mesh(c.headGeom,l);n.position=m.clone();n.position.multiplyScalar(0.95);n.useQuaternion=true;n.quaternion=h;n.updateMatrix();c.add(n);var g=new THREE.Mesh(c.lineGeom,l);g.position=m.clone();g.position.multiplyScalar(0.45);g.useQuaternion=true;g.quaternion=h;g.updateMatrix();c.add(g)}f(new THREE.Vector3(1,0,0));f(new THREE.Vector3(0,1,0));f(new THREE.Vector3(0,0,1))};ROS3D.Axes.prototype.__proto__=THREE.Object3D.prototype;ROS3D.Grid=function(c){var c=c||{};var d=c.size||50;var b=c.color||"#cccccc";var a=c.lineWidth||1;THREE.Mesh.call(this,new THREE.PlaneGeometry(d,d,d,d),new THREE.MeshBasicMaterial({color:b,wireframe:true,wireframeLinewidth:a,transparent:true}))};ROS3D.Grid.prototype.__proto__=THREE.Mesh.prototype;ROS3D.MeshResource=function(c){var e=this;var c=c||{};var h=c.path||"/";var g=c.resource;this.warnings=c.warnings;THREE.Object3D.call(this);if(h.substr(h.length-1)!=="/"){this.path+="/"}var d=h+g;var b=d.substr(-4).toLowerCase();if(d.substr(-4).toLowerCase()===".dae"){var a=new ColladaLoader2();a.log=function(k){if(e.warnings){console.warn(k)}};a.load(d,function f(k){e.add(k.scene)})}};ROS3D.MeshResource.prototype.__proto__=THREE.Object3D.prototype;ROS3D.TriangleList=function(d){var d=d||{};var e=d.material||new THREE.MeshBasicMaterial();var c=d.vertices;var a=d.colors;THREE.Object3D.call(this);e.side=THREE.DoubleSide;var g=new THREE.Geometry();for(i=0;i<c.length;i++){g.vertices.push(new THREE.Vector3(c[i].x,c[i].y,c[i].z))}if(a.length===c.length){for(i=0;i<c.length;i+=3){var f=new THREE.Face3(i,i+1,i+2);for(j=i*3;j<i*3+3;i++){var b=new THREE.Color();b.setRGB(a[i].r,a[i].g,a[i].b);f.vertexColors.push(b)}g.faces.push(f)}e.vertexColors=THREE.VertexColors}else{if(a.length===c.length/3){for(i=0;i<c.length;i+=3){var f=new THREE.Face3(i,i+1,i+2);f.color.setRGB(a[i/3].r,a[i/3].g,a[i/3].b);g.faces.push(f)}e.vertexColors=THREE.FaceColors}else{for(i=0;i<c.length;i+=3){var f=new THREE.Face3(i,i+1,i+2);g.faces.push(f)}}}g.computeBoundingBox();g.computeBoundingSphere();g.computeCentroids();g.computeFaceNormals();this.add(new THREE.Mesh(g,e))};ROS3D.TriangleList.prototype.__proto__=THREE.Object3D.prototype;ROS3D.TriangleList.prototype.setColor=function(a){this.mesh.material.color.setHex(a)};ROS3D.Urdf=function(n){var n=n||{};var e=n.urdfModel;var k=n.path||"/";var g=n.tfClient;THREE.Object3D.call(this);this.useQuaternion=true;var f=e.links;for(var c in f){var d=f[c];if(d.visual&&d.visual.geometry){if(d.visual.geometry.type===ROSLIB.URDF_MESH){var m="/"+d.name;var a=d.visual.geometry.filename;var h=a.substr(-4).toLowerCase();if(h===".dae"){var b=new ROS3D.SceneNode({frameID:m,pose:d.visual.origin,tfClient:g,object:new ROS3D.MeshResource({path:k,resource:a.substring(10)})});this.add(b)}}}}};ROS3D.Urdf.prototype.__proto__=THREE.Object3D.prototype;ROS3D.UrdfClient=function(b){var d=this;var b=b||{};var a=b.ros;var e=b.param||"robot_description";this.path=b.path||"/";this.tfClient=b.tfClient;this.rootObject=b.rootObject||new THREE.Object3D();var c=new ROSLIB.Param({ros:a,name:e});c.get(function(g){var f=new ROSLIB.UrdfModel({string:g});d.rootObject.add(new ROS3D.Urdf({urdfModel:f,path:d.path,tfClient:d.tfClient}))})};ROS3D.SceneNode=function(c){var c=c||{};var e=this;var a=c.tfClient;var d=c.frameID;var b=c.object;this.pose=c.pose||new ROSLIB.Pose();THREE.Object3D.call(this);this.useQuaternion=true;this.add(b);a.subscribe(d,function(h){var g=new ROSLIB.Transform(h);var f=new ROSLIB.Pose(e.pose);f.applyTransform(g);e.position.x=f.position.x;e.position.y=f.position.y;e.position.z=f.position.z;e.quaternion=new THREE.Quaternion(f.orientation.x,f.orientation.y,f.orientation.z,f.orientation.w);e.updateMatrixWorld(true)})};ROS3D.SceneNode.prototype.__proto__=THREE.Object3D.prototype;ROS3D.Viewer=function(l){var e=this;var l=l||{};var c=l.divID;var b=l.width;var h=l.height;var a=l.background||"#111111";var k=l.antialias;var d=l.intensity||0.66;this.renderer=new THREE.WebGLRenderer({antialias:this.antialias});this.renderer.setClearColorHex(a.replace("#","0x"),1);this.renderer.sortObjects=false;this.renderer.setSize(b,h);this.renderer.shadowMapEnabled=false;this.renderer.autoClear=false;this.scene=new THREE.Scene();this.camera=new THREE.PerspectiveCamera(40,b/h,0.01,1000);this.camera.position.x=3;this.camera.position.y=3;this.camera.position.z=3;this.cameraControls=new ROS3D.OrbitControls({scene:this.scene,camera:this.camera});this.cameraControls.userZoomSpeed=0.5;this.scene.add(new THREE.AmbientLight(5592405));this.directionalLight=new THREE.DirectionalLight(16777215,d);this.scene.add(this.directionalLight);this.selectableObjects=new THREE.Object3D;this.scene.add(this.selectableObjects);var f=new ROS3D.MouseHandler({renderer:this.renderer,camera:this.camera,rootObject:this.selectableObjects,fallbackTarget:this.cameraControls});this.highlighter=new ROS3D.Highlighter({mouseHandler:f});function g(){e.cameraControls.update();e.directionalLight.position=e.camera.localToWorld(new THREE.Vector3(-1,1,0));e.directionalLight.position.normalize();e.renderer.clear(true,true,true);e.renderer.render(e.scene,e.camera);e.highlighter.renderHighlight(e.renderer,e.scene,e.camera);requestAnimationFrame(g)}document.getElementById(c).appendChild(this.renderer.domElement);g()};ROS3D.Viewer.prototype.addObject=function(b,a){if(a){this.selectableObjects.add(b)}else{this.scene.add(b)}};ROS3D.Highlighter=function(a){var a=a||{};var b=a.mouseHandler;this.hoverObjs=[];b.addEventListener("mouseover",this.onMouseOver.bind(this));b.addEventListener("mouseout",this.onMouseOut.bind(this))};ROS3D.Highlighter.prototype.onMouseOver=function(a){this.hoverObjs.push(a.currentTarget)};ROS3D.Highlighter.prototype.onMouseOut=function(a){this.hoverObjs.splice(this.hoverObjs.indexOf(a.currentTarget),1)};ROS3D.Highlighter.prototype.getWebglObjects=function(e,d,b){var a=e.__webglObjects;for(var g=0;g<d.length;g++){if(d[g]){for(var f=a.length-1;f>=0;f--){if(a[f].object===d[g]){b.push(a[f]);break}}this.getWebglObjects(e,d[g].children,b)}}};ROS3D.Highlighter.prototype.renderHighlight=function(c,d,a){var b=[];this.getWebglObjects(d,this.hoverObjs,b);d.overrideMaterial=new THREE.MeshBasicMaterial({fog:false,opacity:0.5,depthTest:true,depthWrite:false,polygonOffset:true,polygonOffsetUnits:-1,side:THREE.DoubleSide});var e=d.__webglObjects;d.__webglObjects=b;c.render(d,a);d.__webglObjects=e;d.overrideMaterial=null};ROS3D.MouseHandler=function(a){THREE.EventDispatcher.call(this);this.renderer=a.renderer;this.camera=a.camera;this.rootObject=a.rootObject;this.fallbackTarget=a.fallbackTarget;this.lastTarget=this.fallbackTarget;this.dragging=false;this.projector=new THREE.Projector();var b=["contextmenu","click","dblclick","mouseout","mousedown","mouseup","mousemove","mousewheel","DOMMouseScroll","touchstart","touchend","touchcancel","touchleave","touchmove"];this.listeners={};b.forEach(function(c){this.listeners[c]=this.processDomEvent.bind(this);this.renderer.domElement.addEventListener(c,this.listeners[c],false)},this)};ROS3D.MouseHandler.prototype.processDomEvent=function(k){k.preventDefault();var l=k.target;var n=l.getBoundingClientRect();var f=k.clientX-n.left-l.clientLeft+l.scrollLeft;var m=k.clientY-n.top-l.clientTop+l.scrollTop;var c=f/l.clientWidth*2-1;var a=-m/l.clientHeight*2+1;var e=new THREE.Vector3(c,a,0.5);this.projector.unprojectVector(e,this.camera);var h=new THREE.Raycaster(this.camera.position.clone(),e.sub(this.camera.position).normalize());var o=h.ray;var b={mousePos:new THREE.Vector2(c,a),mouseRay:o,domEvent:k,camera:this.camera,intersection:this.lastIntersection};if(k.type=="mouseout"){if(this.dragging){this.notify(this.lastTarget,"mouseup",b);this.dragging=false}this.notify(this.lastTarget,"mouseout",b);this.lastTarget=null;return}if(this.dragging){this.notify(this.lastTarget,k.type,b);if((k.type==="mouseup"&&k.button===2)||k.type==="click"){this.dragging=false}return}var l=this.lastTarget;var d=[];d=h.intersectObject(this.rootObject,true);if(d.length>0){l=d[0].object;b.intersection=this.lastIntersection=d[0]}else{l=this.fallbackTarget}if(l!==this.lastTarget){var g=this.notify(l,"mouseover",b);if(g){this.notify(this.lastTarget,"mouseout",b)}else{l=this.fallbackTarget;if(l!==this.lastTarget){this.notify(l,"mouseover",b);this.notify(this.lastTarget,"mouseout",b)}}}this.notify(l,k.type,b);if(k.type==="mousedown"){this.dragging=true}this.lastTarget=l};ROS3D.MouseHandler.prototype.notify=function(c,b,a){a.type=b;a.cancelBubble=false;a.stopPropagation=function(){a.cancelBubble=true};a.currentTarget=c;while(a.currentTarget){if(a.currentTarget.dispatchEvent&&a.currentTarget.dispatchEvent instanceof Function){a.currentTarget.dispatchEvent(a);if(a.cancelBubble){this.dispatchEvent(a);return true}}a.currentTarget=a.currentTarget.parent}return false};ROS3D.MouseHandler.prototype.destroy=function(){this.listeners.forEach(function(a){this.renderer.domElement.removeEventListener(eventName,a,false)},this)};ROS3D.OrbitControls=function(e){THREE.EventDispatcher.call(this);var l=this;var e=e||{};var w=e.scene;this.camera=e.camera;this.center=new THREE.Vector3();this.userZoom=true;this.userZoomSpeed=e.userZoomSpeed||1;this.userRotate=true;this.userRotateSpeed=e.userRotateSpeed||1;this.autoRotate=e.autoRotate;this.autoRotateSpeed=e.autoRotateSpeed||2;this.camera.up=new THREE.Vector3(0,0,1);var u=1800;var v=new THREE.Vector2();var g=new THREE.Vector2();var r=new THREE.Vector2();var t=new THREE.Vector2();var x=new THREE.Vector2();var o=new THREE.Vector2();var m=new THREE.Vector3();var p=new THREE.Vector3();var c=new THREE.Vector3();var b=new THREE.Vector3();this.phiDelta=0;this.thetaDelta=0;this.scale=1;this.lastPosition=new THREE.Vector3();var s={NONE:-1,ROTATE:0,ZOOM:1,MOVE:2};var h=s.NONE;this.axes=new ROS3D.Axes({shaftRadius:0.025,headRadius:0.07,headLength:0.2});w.add(this.axes);this.axes.traverse(function(y){y.visible=false});function k(y){var z=y.domEvent;z.preventDefault();switch(z.button){case 0:h=s.ROTATE;v.set(z.clientX,z.clientY);break;case 1:h=s.MOVE;p=new THREE.Vector3(0,0,1);var A=new THREE.Matrix4().extractRotation(this.camera.matrix);p.applyMatrix4(A);m=l.center.clone();c=l.camera.position.clone();b=ROS3D.intersectPlane(y.mouseRay,m,p);break;case 2:h=s.ZOOM;t.set(z.clientX,z.clientY);break}this.showAxes()}function q(y){var z=y.domEvent;if(h===s.ROTATE){g.set(z.clientX,z.clientY);r.subVectors(g,v);l.rotateLeft(2*Math.PI*r.x/u*l.userRotateSpeed);l.rotateUp(2*Math.PI*r.y/u*l.userRotateSpeed);v.copy(g);this.showAxes()}else{if(h===s.ZOOM){x.set(z.clientX,z.clientY);o.subVectors(x,t);if(o.y>0){l.zoomIn()}else{l.zoomOut()}t.copy(x);this.showAxes()}else{if(h===s.MOVE){var B=ROS3D.intersectPlane(y.mouseRay,l.center,p);if(!B){return}var A=new THREE.Vector3().subVectors(b.clone(),B.clone());l.center.addVectors(m.clone(),A.clone());l.camera.position.addVectors(c.clone(),A.clone());l.update();l.camera.updateMatrixWorld();this.showAxes()}}}}function d(y){if(!l.userRotate){return}h=s.NONE}function n(y){if(!l.userZoom){return}var z=y.domEvent;if(typeof(z.wheelDelta)!=="undefined"){var A=z.wheelDelta}else{var A=-z.detail}if(A>0){l.zoomOut()}else{l.zoomIn()}this.showAxes()}function a(y){k(y);y.preventDefault()}function f(y){q(y);y.preventDefault()}this.addEventListener("mousedown",k);this.addEventListener("mouseup",d);this.addEventListener("mousemove",q);this.addEventListener("touchstart",a);this.addEventListener("touchmove",f);this.addEventListener("mousewheel",n);this.addEventListener("DOMMouseScroll",n)};ROS3D.OrbitControls.prototype.showAxes=function(){var a=this;this.axes.traverse(function(b){b.visible=true});if(this.hideTimeout){clearTimeout(this.hideTimeout)}this.hideTimeout=setTimeout(function(){a.axes.traverse(function(b){b.visible=false});a.hideTimeout=false},1000)};ROS3D.OrbitControls.prototype.rotateLeft=function(a){if(a===undefined){a=2*Math.PI/60/60*this.autoRotateSpeed}this.thetaDelta-=a};ROS3D.OrbitControls.prototype.rotateRight=function(a){if(a===undefined){a=2*Math.PI/60/60*this.autoRotateSpeed}this.thetaDelta+=a};ROS3D.OrbitControls.prototype.rotateUp=function(a){if(a===undefined){a=2*Math.PI/60/60*this.autoRotateSpeed}this.phiDelta-=a};ROS3D.OrbitControls.prototype.rotateDown=function(a){if(a===undefined){a=2*Math.PI/60/60*this.autoRotateSpeed}this.phiDelta+=a};ROS3D.OrbitControls.prototype.zoomIn=function(a){if(a===undefined){a=Math.pow(0.95,this.userZoomSpeed)}this.scale/=a};ROS3D.OrbitControls.prototype.zoomOut=function(a){if(a===undefined){a=Math.pow(0.95,this.userZoomSpeed)}this.scale*=a};ROS3D.OrbitControls.prototype.update=function(){var b=this.camera.position;var f=b.clone().sub(this.center);var d=Math.atan2(f.y,f.x);var e=Math.atan2(Math.sqrt(f.y*f.y+f.x*f.x),f.z);if(this.autoRotate){this.rotateLeft(2*Math.PI/60/60*this.autoRotateSpeed)}d+=this.thetaDelta;e+=this.phiDelta;var c=0.000001;e=Math.max(c,Math.min(Math.PI-c,e));var a=f.length();f.y=a*Math.sin(e)*Math.sin(d);f.z=a*Math.cos(e);f.x=a*Math.sin(e)*Math.cos(d);f.multiplyScalar(this.scale);b.copy(this.center).add(f);this.camera.lookAt(this.center);a=f.length();this.axes.position=this.center.clone();this.axes.scale.x=this.axes.scale.y=this.axes.scale.z=a*0.05;this.axes.updateMatrixWorld(true);this.thetaDelta=0;this.phiDelta=0;this.scale=1;if(this.lastPosition.distanceTo(this.camera.position)>0){this.dispatchEvent({type:"change"});this.lastPosition.copy(this.camera.position)}};