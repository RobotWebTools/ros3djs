var ROS3D=ROS3D||{REVISION:"1"};ROS3D.UrdfColor=function(f,e,c,d){this.r=f;this.g=e;this.b=c;this.a=d};ROS3D.UrdfJoint=function(){this.name="";this.JointTypes={unknown:0,revolute:1,continuous:3,prismatic:4,floating:5,planar:6,fixed:7};this.type=this.JointTypes.unknown;this.axis=new UrdfVector3();this.child_link_name="";this.parent_link_name="";this.parent_to_joint_origin_transform=new UrdfPose();this.dynamics=null;this.limits=null;this.safety=null;this.calibration=null;this.mimic=null;this.clear=function(){this.name="";this.axis.clear();this.child_link_name="";this.parent_link_name="";this.parent_to_joint_origin_transform.clear();this.dynamics=null;this.limits=null;this.safety=null;this.calibration=null;this.mimic=null;this.type=this.JointTypes.unknown};this.init=function(h){this.clear();var b=h.getAttribute("name");if(!b){console.error("unnamed joint found");return false}this.name=b;var k=h.getElementsByTagName("origin");if(k.length==0){this.parent_to_joint_origin_transform.clear()}else{origin_xml=k[0];if(!this.parent_to_joint_origin_transform.initXml(origin_xml)){console.error("Malformed parent origin element for joint "+this.name);this.parent_to_joint_origin_transform.clear();return false}}var l=h.getElementsByTagName("parent");if(l.length>0){var j=l[0];var g=j.getAttribute("link");if(!g){ros_info("no parent link name specified for Joint link "+this.name+". this might be the root?")}else{this.parent_link_name=g}}var d=h.getElementsByTagName("child");if(d.length>0){var c=d[0];var g=c.getAttribute("link");if(!g){ros_info("no child link name specified for Joint link "+this.name)}else{this.child_link_name=g}}var a=h.getAttribute("type");if(!a){console.error("joint "+this.name+" has no type, check to see if it's a reference.");return false}var f=a;if(f=="planar"){this.type=this.JointTypes.planar}else{if(f=="floating"){this.type=this.JointTypes.floating}else{if(f=="revolute"){this.type=this.JointTypes.revolute}else{if(f=="continuous"){this.type=this.JointTypes.continuous}else{if(f=="prismatic"){this.type=this.JointTypes.prismatic}else{if(f=="fixed"){this.type=this.JointTypes.fixed}else{console.error("Joint "+this.name+" has no known type "+f);return false}}}}}}if(this.type!=this.JointTypes.floating&&this.type!=this.JointTypes.fixed){var e=h.getElementsByTagName("axis");if(e.length==0){this.axis=new Vector3(1,0,0)}else{var i=e[0];if(!i.getAttribute("xyz")){console.error("no xyz attribute for axis element for Joint link "+this.name)}else{if(!this.axis.initString(i.getAttribute("xyz"))){console.error("Malformed axis element for joint "+this.name);this.axis.clear();return false}}}}return true}};ROS3D.UrdfMaterial=function(){var a=this;this.name;this.textureFilename;this.color;this.init=function(f){var j=false;var h=false;if(!(a.name=f.getAttribute("name"))){console.error("URDF Material must contain a name attribute.");return false}var b=f.getElementsByTagName("texture");if(b.length>0){var g=b[0];if((a.textureFilename=g.getAttribute("filename"))){h=true}else{console.error("URDF texture has no filename for material "+a.name+".")}}var d=f.getElementsByTagName("color");if(d.length>0){var i=d[0];if(i.getAttribute("rgba")){var e=i.getAttribute("rgba").split(" ");a.color=new ROS3D.UrdfColor(parseInt(e[0],e[1],e[2],e[3]));j=true}else{console.error("Material "+this.name+" color has no rgba.")}}if(j||h){return true}else{console.error("Material "+this.name+" has no color or texture.");return false}}};ROS3D.UrdfModel=function(){var a=this;this.name;this.materials=[];this.initXml=function(f){var b=new DOMParser();var j=b.parseFromString(f,"text/xml");var e=j.evaluate("//robot",j,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(!e){console.error('Could not find the "robot" element in the URDF XML file.');return false}if(!(a.name=e.getAttribute("name"))){console.error("No name given for the robot.");return false}for(n in e.childNodes){var c=e.childNodes[n];if(c.tagName==="material"){var g=new ROS3D.UrdfMaterial();if(g.init(c)){if(a.materials[g.name]){console.error("Material "+g.name+"is not unique.");return false}else{a.materials[g.name]=g}}else{return false}}else{if(c.tagName==="link"){continue;var h=c;var i=new UrdfLink();if(i.initXml(h)){if(a.getLink(i.name)){console.error("link "+i.name+" is not unique. ");return false}else{if(i.visual){if(i.visual.material_name.length>0){if(a.getMaterial(i.visual.material_name)){i.visual.material=a.getMaterial(i.visual.material_name)}else{if(i.visual.material){a.links_[i.visual.material.name]=i.visual.material}else{console.error("link "+i.name+" material "+i.visual.material_name+" undefined.");return false}}}}a.links_[i.name]=i}}else{return false}if(a.links_.length==0){console.error("No link elements found in urdf file");return false}}else{if(c.tagName==="joint"){var d=new ROS3D.UrdfJoint();if(d.init(c)){if(a.joints[d.name]){console.error("Joint "+d.name+" is not unique.");return false}else{a.joints[d.name]=d}}else{return false}}}}}this.emit("ready");return true}};ROS3D.UrdfModel.prototype.__proto__=EventEmitter2.prototype;ROS3D.Axes=function(b){var f=this;b=b||{};var d=b.shaftRadius||0.008;var c=b.headRadius||0.023;var a=b.headLength||0.1;THREE.Object3D.call(this);this.lineGeom=new THREE.CylinderGeometry(d,d,1-a);this.headGeom=new THREE.CylinderGeometry(0,c,a);function e(k){var i=new THREE.Color;i.setRGB(k.x,k.y,k.z);var j=new THREE.MeshBasicMaterial({color:i.getHex()});var m=new THREE.Vector3;m.crossVectors(k,new THREE.Vector3(0,-1,0));var h=new THREE.Quaternion;h.setFromAxisAngle(m,0.5*Math.PI);var l=new THREE.Mesh(f.headGeom,j);l.position=k.clone();l.position.multiplyScalar(0.95);l.useQuaternion=true;l.quaternion=h;l.updateMatrix();f.add(l);var g=new THREE.Mesh(f.lineGeom,j);g.position=k.clone();g.position.multiplyScalar(0.45);g.useQuaternion=true;g.quaternion=h;g.updateMatrix();f.add(g)}e(new THREE.Vector3(1,0,0));e(new THREE.Vector3(0,1,0));e(new THREE.Vector3(0,0,1))};ROS3D.Axes.prototype=Object.create(THREE.Object3D.prototype);ROS3D.OrbitControls=function(y,F){THREE.EventDispatcher.call(this);this.object=F;this.object.up=new THREE.Vector3(0,0,1);this.center=new THREE.Vector3();this.userZoom=true;this.userZoomSpeed=1;this.userRotate=true;this.userRotateSpeed=1;this.autoRotate=false;this.autoRotateSpeed=2;var d=this;var t=0.000001;var C=1800;var x=new THREE.Vector2();var g=new THREE.Vector2();var r=new THREE.Vector2();var w=new THREE.Vector2();var E=new THREE.Vector2();var o=new THREE.Vector2();var l=new THREE.Vector3();var p=new THREE.Vector3();var c=new THREE.Vector3();var b=new THREE.Vector3();var i=0;var A=0;var D=1;var s=new THREE.Vector3();var v={NONE:-1,ROTATE:0,ZOOM:1,MOVE:2};var h=v.NONE;function j(){return 2*Math.PI/60/60*d.autoRotateSpeed}function u(){return Math.pow(0.95,d.userZoomSpeed)}function B(I,G,J){var H=new THREE.Vector3();var K=new THREE.Vector3();H.subVectors(G,I.origin);dot=I.direction.dot(J);if(Math.abs(dot)<I.precision){return null}scalar=J.dot(H)/dot;K=I.direction.clone().multiplyScalar(scalar);return K}this.axes=new ROS3D.Axes({shaftRadius:0.025,headRadius:0.07,headLength:0.2});y.add(this.axes);this.axes.traverse(function(G){G.visible=false});this.showAxes=function(){d.axes.traverse(function(G){G.visible=true});if(this.hideTimeout){clearTimeout(this.hideTimeout)}d.hideTimeout=setTimeout(function(){d.axes.traverse(function(G){G.visible=false});d.hideTimeout=false},1000)};var z={type:"change"};function k(G){var H=G.domEvent;H.preventDefault();switch(H.button){case 0:h=v.ROTATE;x.set(H.clientX,H.clientY);break;case 1:h=v.MOVE;p=new THREE.Vector3(0,0,1);var I=new THREE.Matrix4().extractRotation(F.matrix);p.applyMatrix4(I);l=d.center.clone();c=d.object.position.clone();b=B(G.mouseRay,l,p);break;case 2:h=v.ZOOM;w.set(H.clientX,H.clientY);break}this.showAxes()}function q(G){var H=G.domEvent;if(h===v.ROTATE){g.set(H.clientX,H.clientY);r.subVectors(g,x);d.rotateLeft(2*Math.PI*r.x/C*d.userRotateSpeed);d.rotateUp(2*Math.PI*r.y/C*d.userRotateSpeed);x.copy(g);this.showAxes()}else{if(h===v.ZOOM){E.set(H.clientX,H.clientY);o.subVectors(E,w);if(o.y>0){d.zoomIn()}else{d.zoomOut()}w.copy(E);this.showAxes()}else{if(h===v.MOVE){var J=B(G.mouseRay,d.center,p);if(!J){return}var I=new THREE.Vector3().subVectors(b.clone(),J.clone());d.center.addVectors(l.clone(),I.clone());d.object.position.addVectors(c.clone(),I.clone());d.update();d.object.updateMatrixWorld();this.showAxes()}}}}function e(G){if(!d.userRotate){return}h=v.NONE}function m(G){if(!d.userZoom){return}var H=G.domEvent;if(typeof(H.wheelDelta)!=="undefined"){var I=H.wheelDelta}else{var I=-H.detail}if(I>0){d.zoomOut()}else{d.zoomIn()}this.showAxes()}function a(G){k(G);G.preventDefault()}function f(G){q(G);G.preventDefault()}this.rotateLeft=function(G){if(G===undefined){G=j()}A-=G};this.rotateRight=function(G){if(G===undefined){G=j()}A+=G};this.rotateUp=function(G){if(G===undefined){G=j()}i-=G};this.rotateDown=function(G){if(G===undefined){G=j()}i+=G};this.zoomIn=function(G){if(G===undefined){G=u()}D/=G};this.zoomOut=function(G){if(G===undefined){G=u()}D*=G};this.update=function(){var H=this.object.position;var K=H.clone().sub(this.center);var I=Math.atan2(K.y,K.x);var J=Math.atan2(Math.sqrt(K.y*K.y+K.x*K.x),K.z);if(this.autoRotate){this.rotateLeft(j())}I+=A;J+=i;J=Math.max(t,Math.min(Math.PI-t,J));var G=K.length();K.y=G*Math.sin(J)*Math.sin(I);K.z=G*Math.cos(J);K.x=G*Math.sin(J)*Math.cos(I);K.multiplyScalar(D);H.copy(this.center).add(K);this.object.lookAt(this.center);G=K.length();this.axes.position=this.center.clone();this.axes.scale.x=this.axes.scale.y=this.axes.scale.z=G*0.05;this.axes.updateMatrixWorld(true);A=0;i=0;D=1;if(s.distanceTo(this.object.position)>0){this.dispatchEvent(z);s.copy(this.object.position)}};this.addEventListener("mousedown",k);this.addEventListener("mouseup",e);this.addEventListener("mousemove",q);this.addEventListener("touchstart",a);this.addEventListener("touchmove",f);this.addEventListener("mousewheel",m);this.addEventListener("DOMMouseScroll",m)};ROS3D.UrdfLoader=function(b){var a=this;var b=b||{};this.ros=b.ros;this.xmlParam=b.xmlParam||"robot_description";this.urdf=new ROS3D.UrdfModel();this.urdf.on("ready",function(){console.log("OKAY")});var c=new ROSLIB.Param({ros:this.ros,name:this.xmlParam});c.get(function(d){a.urdf.initXml(d)})};var UrdfLoader={};UrdfLoader.load=function(g,e,b,h){var a=new UrdfModel();var f=this;var d={};a.initFile(h,c);function c(){var s=a.getLinks();for(var m in s){var r=s[m];if(!r.visual){continue}if(!r.visual.geometry){continue}if(r.visual.geometry.type==r.visual.geometry.GeometryTypes.MESH){var j=new String("/"+r.name);var i=r.visual.geometry.filename;var t=i.substr(-4).toLowerCase();if(t==".dae"){var k=r.visual.material_name;var q=a.getMaterial(k);var o=e.load(i,q);var p=new SceneNode({frame_id:j,tfclient:b,pose:r.visual.origin,model:o});g.add(p)}else{console.log("Not Supported format : ",i)}}}}};ROS3D.Viewer=function(d){var g=this;d=d||{};this.divID=d.divID;this.width=d.width;this.height=d.height;this.disableGrid=d.disableGrid;this.gridColor=d.gridColor||"#cccccc";this.background=d.background||"#111111";this.antialias=d.antialias;this.renderer=new THREE.WebGLRenderer({antialias:this.antialias});this.renderer.setClearColorHex(this.background.replace("#","0x"),1);this.renderer.sortObjects=false;this.renderer.setSize(this.width,this.height);this.renderer.shadowMapEnabled=false;this.renderer.autoClear=false;this.scene=new THREE.Scene();this.camera=new THREE.PerspectiveCamera(40,this.width/this.height,0.01,1000);this.camera.position.x=3;this.camera.position.y=3;this.camera.position.z=3;this.cameraControls=new ROS3D.OrbitControls(this.scene,this.camera);this.cameraControls.userZoomSpeed=0.5;if(!this.disableGrid){var b=new THREE.PlaneGeometry(50,50,50,50);var c=new THREE.MeshBasicMaterial({color:this.gridColor,wireframe:true,wireframeLinewidth:1,transparent:true});var f=new THREE.Mesh(b,c);this.scene.add(f)}this.scene.add(new THREE.AmbientLight(5592405));this.directionalLight=new THREE.DirectionalLight(16777215);this.scene.add(this.directionalLight);this.selectableObjs=new THREE.Object3D;this.scene.add(this.selectableObjs);var e=new ROS3D.MouseHandler(this.renderer,this.camera,this.selectableObjs,this.cameraControls);this.highlighter=new ROS3D.Highlighter(e);function a(){g.cameraControls.update();g.directionalLight.position=g.camera.localToWorld(new THREE.Vector3(-1,1,0));g.directionalLight.position.normalize();g.renderer.clear(true,true,true);g.renderer.render(g.scene,g.camera);g.highlighter.renderHighlight(g.renderer,g.scene,g.camera);requestAnimationFrame(a)}document.getElementById(this.divID).appendChild(this.renderer.domElement);a()};ROS3D.Highlighter=function(a){this.hoverObjs=[];this.onMouseOver=function(b){this.hoverObjs.push(b.currentTarget)};this.onMouseOut=function(b){this.hoverObjs.splice(this.hoverObjs.indexOf(b.currentTarget),1)};this.getWebglObjects=function(f,e,d){var b=f.__webglObjects;for(var h=0;h<e.length;h++){if(e[h]){for(var g=b.length-1;g>=0;g--){if(b[g].object===e[h]){d.push(b[g]);break}}this.getWebglObjects(f,e[h].children,d)}}};this.renderHighlight=function(d,e,b){var c=[];this.getWebglObjects(e,this.hoverObjs,c);e.overrideMaterial=new THREE.MeshBasicMaterial({fog:false,opacity:0.5,depthTest:true,depthWrite:false,polygonOffset:true,polygonOffsetUnits:-1,side:THREE.DoubleSide});var f=e.__webglObjects;e.__webglObjects=c;d.render(e,b);e.__webglObjects=f;e.overrideMaterial=null};a.addEventListener("mouseover",this.onMouseOver.bind(this));a.addEventListener("mouseout",this.onMouseOut.bind(this))};ROS3D.MouseHandler=function(c,a,b,e){THREE.EventDispatcher.call(this);this.camera=a;this.rootObj=b;this.renderer=c;this.fallbackTarget=e;this.lastTarget=e;this.dragging=false;this.projector=new THREE.Projector();var d=["contextmenu","click","dblclick","mouseout","mousedown","mouseup","mousemove","mousewheel","DOMMouseScroll","touchstart","touchend","touchcancel","touchleave","touchmove"];this.listeners={};this.processDomEvent=function(o){o.preventDefault();var p=o.target;var r=p.getBoundingClientRect();var k=o.clientX-r.left-p.clientLeft+p.scrollLeft;var q=o.clientY-r.top-p.clientTop+p.scrollTop;var h=k/p.clientWidth*2-1;var f=-q/p.clientHeight*2+1;var j=new THREE.Vector3(h,f,0.5);this.projector.unprojectVector(j,this.camera);var m=new THREE.Raycaster(this.camera.position.clone(),j.sub(this.camera.position).normalize());var s=m.ray;var g={mousePos:new THREE.Vector2(h,f),mouseRay:s,domEvent:o,camera:this.camera,intersection:this.lastIntersection};if(o.type=="mouseout"){if(this.dragging){this.notify(this.lastTarget,"mouseup",g);this.dragging=false}this.notify(this.lastTarget,"mouseout",g);this.lastTarget=null;return}if(this.dragging){this.notify(this.lastTarget,o.type,g);if((o.type==="mouseup"&&o.button===2)||o.type==="click"){this.dragging=false}return}var p=this.lastTarget;var i=[];i=m.intersectObject(this.rootObj,true);if(i.length>0){p=i[0].object;g.intersection=this.lastIntersection=i[0]}else{p=this.fallbackTarget}if(p!==this.lastTarget){var l=this.notify(p,"mouseover",g);if(l){this.notify(this.lastTarget,"mouseout",g)}else{p=this.fallbackTarget;if(p!==this.lastTarget){this.notify(p,"mouseover",g);this.notify(this.lastTarget,"mouseout",g)}}}this.notify(p,o.type,g);if(o.type==="mousedown"){this.dragging=true}this.lastTarget=p};this.notify=function(h,g,f){f.type=g;f.cancelBubble=false;f.stopPropagation=function(){f.cancelBubble=true};f.currentTarget=h;while(f.currentTarget){if(f.currentTarget.dispatchEvent&&f.currentTarget.dispatchEvent instanceof Function){f.currentTarget.dispatchEvent(f);if(f.cancelBubble){this.dispatchEvent(f);return true}}f.currentTarget=f.currentTarget.parent}return false};this.destroy=function(){this.listeners.forEach(function(f){this.renderer.domElement.removeEventListener(eventName,f,false)},this)};d.forEach(function(f){this.listeners[f]=this.processDomEvent.bind(this);this.renderer.domElement.addEventListener(f,this.listeners[f],false)},this)};