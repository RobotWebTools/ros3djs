var ROS3D=ROS3D||{REVISION:"7"};ROS3D.MARKER_ARROW=0,ROS3D.MARKER_CUBE=1,ROS3D.MARKER_SPHERE=2,ROS3D.MARKER_CYLINDER=3,ROS3D.MARKER_LINE_STRIP=4,ROS3D.MARKER_LINE_LIST=5,ROS3D.MARKER_CUBE_LIST=6,ROS3D.MARKER_SPHERE_LIST=7,ROS3D.MARKER_POINTS=8,ROS3D.MARKER_TEXT_VIEW_FACING=9,ROS3D.MARKER_MESH_RESOURCE=10,ROS3D.MARKER_TRIANGLE_LIST=11,ROS3D.INTERACTIVE_MARKER_KEEP_ALIVE=0,ROS3D.INTERACTIVE_MARKER_POSE_UPDATE=1,ROS3D.INTERACTIVE_MARKER_MENU_SELECT=2,ROS3D.INTERACTIVE_MARKER_BUTTON_CLICK=3,ROS3D.INTERACTIVE_MARKER_MOUSE_DOWN=4,ROS3D.INTERACTIVE_MARKER_MOUSE_UP=5,ROS3D.INTERACTIVE_MARKER_NONE=0,ROS3D.INTERACTIVE_MARKER_MENU=1,ROS3D.INTERACTIVE_MARKER_BUTTON=2,ROS3D.INTERACTIVE_MARKER_MOVE_AXIS=3,ROS3D.INTERACTIVE_MARKER_MOVE_PLANE=4,ROS3D.INTERACTIVE_MARKER_ROTATE_AXIS=5,ROS3D.INTERACTIVE_MARKER_MOVE_ROTATE=6,ROS3D.INTERACTIVE_MARKER_INHERIT=0,ROS3D.INTERACTIVE_MARKER_FIXED=1,ROS3D.INTERACTIVE_MARKER_VIEW_FACING=2,ROS3D.makeColorMaterial=function(a,b,c,d){var e=new THREE.Color;return e.setRGB(a,b,c),.99>=d?new THREE.MeshBasicMaterial({color:e.getHex(),opacity:d+.1,transparent:!0,depthWrite:!0,blendSrc:THREE.SrcAlphaFactor,blendDst:THREE.OneMinusSrcAlphaFactor,blendEquation:THREE.ReverseSubtractEquation,blending:THREE.NormalBlending}):new THREE.MeshLambertMaterial({color:e.getHex(),opacity:d,blending:THREE.NormalBlending})},ROS3D.intersectPlane=function(a,b,c){var d=new THREE.Vector3,e=new THREE.Vector3;d.subVectors(b,a.origin);var f=a.direction.dot(c);if(Math.abs(f)<a.precision)return void 0;var g=c.dot(d)/f;return e.addVectors(a.origin,a.direction.clone().multiplyScalar(g)),e},ROS3D.findClosestPoint=function(a,b){var c=new THREE.Vector3;c.subVectors(a.origin,b.origin);var d=b.direction.clone(),e=a.direction.clone(),f=c.dot(d),g=d.dot(e),h=c.dot(e),i=d.dot(d),j=e.dot(e),k=j*i-g*g;if(Math.abs(k)<=1e-4)return void 0;var l=f*g-h*i,m=l/k;return m},ROS3D.closestAxisPoint=function(a,b,c){var d=new THREE.Projector,e=a.origin.clone();d.projectVector(e,b);var f=a.direction.clone().add(a.origin);d.projectVector(f,b);var g=f.clone().sub(e),h=new THREE.Vector2,i=h.subVectors(c,e).dot(g)/g.dot(g),j=new THREE.Vector2;j.addVectors(e,g.clone().multiplyScalar(i));var k=new THREE.Vector3(j.x,j.y,.5);d.unprojectVector(k,b);var l=new THREE.Ray(b.position,k.sub(b.position).normalize());return ROS3D.findClosestPoint(a,l)},ROS3D.DepthCloud=function(a){a=a||{},THREE.Object3D.call(this),this.url=a.url,this.f=a.f||526,this.pointSize=a.pointSize||3,this.width=a.width||1024,this.height=a.height||1024,this.whiteness=a.whiteness||0,this.varianceThreshold=a.varianceThreshold||16667e-9,this.video=document.createElement("video"),this.video.addEventListener("loadedmetadata",this.metaLoaded.bind(this),!1),this.video.loop=!0,this.video.src=this.url,this.video.crossOrigin="Anonymous",this.video.setAttribute("crossorigin","Anonymous"),this.vertex_shader=["uniform sampler2D map;","","uniform float width;","uniform float height;","uniform float nearClipping, farClipping;","","uniform float pointSize;","uniform float zOffset;","","uniform float focallength;","","varying vec2 vUvP;","varying vec2 colorP;","","varying float depthVariance;","varying float maskVal;","","float sampleDepth(vec2 pos)","  {","    float depth;","    ","    vec2 vUv = vec2( pos.x / (width*2.0), pos.y / (height*2.0)+0.5 );","    vec2 vUv2 = vec2( pos.x / (width*2.0)+0.5, pos.y / (height*2.0)+0.5 );","    ","    vec4 depthColor = texture2D( map, vUv );","    ","    depth = ( depthColor.r + depthColor.g + depthColor.b ) / 3.0 ;","    ","    if (depth>0.99)","    {","      vec4 depthColor2 = texture2D( map, vUv2 );","      float depth2 = ( depthColor2.r + depthColor2.g + depthColor2.b ) / 3.0 ;","      depth = 0.99+depth2;","    }","    ","    return depth;","  }","","float median(float a, float b, float c)","  {","    float r=a;","    ","    if ( (a<b) && (b<c) )","    {","      r = b;","    }","    if ( (a<c) && (c<b) )","    {","      r = c;","    }","    return r;","  }","","float variance(float d1, float d2, float d3, float d4, float d5, float d6, float d7, float d8, float d9)","  {","    float mean = (d1 + d2 + d3 + d4 + d5 + d6 + d7 + d8 + d9) / 9.0;","    float t1 = (d1-mean);","    float t2 = (d2-mean);","    float t3 = (d3-mean);","    float t4 = (d4-mean);","    float t5 = (d5-mean);","    float t6 = (d6-mean);","    float t7 = (d7-mean);","    float t8 = (d8-mean);","    float t9 = (d9-mean);","    float v = (t1*t1+t2*t2+t3*t3+t4*t4+t5*t5+t6*t6+t7*t7+t8*t8+t9*t9)/9.0;","    return v;","  }","","vec2 decodeDepth(vec2 pos)","  {","    vec2 ret;","    ","    ","    float depth1 = sampleDepth(vec2(position.x-1.0, position.y-1.0));","    float depth2 = sampleDepth(vec2(position.x, position.y-1.0));","    float depth3 = sampleDepth(vec2(position.x+1.0, position.y-1.0));","    float depth4 = sampleDepth(vec2(position.x-1.0, position.y));","    float depth5 = sampleDepth(vec2(position.x, position.y));","    float depth6 = sampleDepth(vec2(position.x+1.0, position.y));","    float depth7 = sampleDepth(vec2(position.x-1.0, position.y+1.0));","    float depth8 = sampleDepth(vec2(position.x, position.y+1.0));","    float depth9 = sampleDepth(vec2(position.x+1.0, position.y+1.0));","    ","    float median1 = median(depth1, depth2, depth3);","    float median2 = median(depth4, depth5, depth6);","    float median3 = median(depth7, depth8, depth9);","    ","    ret.x = median(median1, median2, median3);","    ret.y = variance(depth1, depth2, depth3, depth4, depth5, depth6, depth7, depth8, depth9);","    ","    return ret;","    ","  }","","","void main() {","  ","  vUvP = vec2( position.x / (width*2.0), position.y / (height*2.0)+0.5 );","  colorP = vec2( position.x / (width*2.0)+0.5 , position.y / (height*2.0)  );","  ","  vec4 pos = vec4(0.0,0.0,0.0,0.0);","  depthVariance = 0.0;","  ","  if ( (vUvP.x<0.0)|| (vUvP.x>0.5) || (vUvP.y<0.5) || (vUvP.y>0.0))","  {","    vec2 smp = decodeDepth(vec2(position.x, position.y));","    float depth = smp.x;","    depthVariance = smp.y;","    ","    float z = -depth;","    ","    pos = vec4(","      ( position.x / width - 0.5 ) * z * (1000.0/focallength) * -1.0,","      ( position.y / height - 0.5 ) * z * (1000.0/focallength),","      (- z + zOffset / 1000.0) * 2.0,","      1.0);","    ","    vec2 maskP = vec2( position.x / (width*2.0), position.y / (height*2.0)  );","    vec4 maskColor = texture2D( map, maskP );","    maskVal = ( maskColor.r + maskColor.g + maskColor.b ) / 3.0 ;","  }","  ","  gl_PointSize = pointSize;","  gl_Position = projectionMatrix * modelViewMatrix * pos;","  ","}"].join("\n"),this.fragment_shader=["uniform sampler2D map;","uniform float varianceThreshold;","uniform float whiteness;","","varying vec2 vUvP;","varying vec2 colorP;","","varying float depthVariance;","varying float maskVal;","","","void main() {","  ","  vec4 color;","  ","  if ( (depthVariance>varianceThreshold) || (maskVal>0.5) ||(vUvP.x<0.0)|| (vUvP.x>0.5) || (vUvP.y<0.5) || (vUvP.y>1.0))","  {  ","    discard;","  }","  else ","  {","    color = texture2D( map, colorP );","    ","    float fader = whiteness /100.0;","    ","    color.r = color.r * (1.0-fader)+ fader;","    ","    color.g = color.g * (1.0-fader)+ fader;","    ","    color.b = color.b * (1.0-fader)+ fader;","    ","    color.a = 1.0;//smoothstep( 20000.0, -20000.0, gl_FragCoord.z / gl_FragCoord.w );","  }","  ","  gl_FragColor = vec4( color.r, color.g, color.b, color.a );","  ","}"].join("\n")},ROS3D.DepthCloud.prototype.__proto__=THREE.Object3D.prototype,ROS3D.DepthCloud.prototype.metaLoaded=function(){this.metaLoaded=!0,this.initStreamer()},ROS3D.DepthCloud.prototype.initStreamer=function(){if(this.metaLoaded){this.texture=new THREE.Texture(this.video),this.geometry=new THREE.Geometry;for(var a=0,b=this.width*this.height;b>a;a++){var c=new THREE.Vector3;c.x=a%this.width,c.y=Math.floor(a/this.width),this.geometry.vertices.push(c)}this.material=new THREE.ShaderMaterial({uniforms:{map:{type:"t",value:this.texture},width:{type:"f",value:this.width},height:{type:"f",value:this.height},focallength:{type:"f",value:this.f},pointSize:{type:"f",value:this.pointSize},zOffset:{type:"f",value:0},whiteness:{type:"f",value:this.whiteness},varianceThreshold:{type:"f",value:this.varianceThreshold}},vertexShader:this.vertex_shader,fragmentShader:this.fragment_shader}),this.mesh=new THREE.ParticleSystem(this.geometry,this.material),this.mesh.position.x=0,this.mesh.position.y=0,this.add(this.mesh);var d=this;setInterval(function(){d.video.readyState===d.video.HAVE_ENOUGH_DATA&&(d.texture.needsUpdate=!0)},1e3/30)}},ROS3D.DepthCloud.prototype.startStream=function(){this.video.play()},ROS3D.DepthCloud.prototype.stopStream=function(){this.video.stop()},ROS3D.InteractiveMarker=function(a){THREE.Object3D.call(this),THREE.EventDispatcher.call(this);var b=this;a=a||{};var c=a.handle;this.name=c.name;var d=a.camera,e=a.path||"/";this.dragging=!1,this.onServerSetPose({pose:c.pose}),this.dragStart={position:new THREE.Vector3,orientation:new THREE.Quaternion,positionWorld:new THREE.Vector3,orientationWorld:new THREE.Quaternion,event3d:{}},c.controls.forEach(function(a){b.add(new ROS3D.InteractiveMarkerControl({parent:b,message:a,camera:d,path:e}))}),c.menuEntries.length>0&&(this.menu=new ROS3D.InteractiveMarkerMenu({menuEntries:c.menuEntries}),this.menu.addEventListener("menu-select",function(a){b.dispatchEvent(a)}))},ROS3D.InteractiveMarker.prototype.__proto__=THREE.Object3D.prototype,ROS3D.InteractiveMarker.prototype.showMenu=function(a,b){this.menu&&this.menu.show(a,b)},ROS3D.InteractiveMarker.prototype.moveAxis=function(a,b,c){if(this.dragging){var d=a.currentControlOri,e=b.clone().applyQuaternion(d),f=this.dragStart.event3d.intersection.point,g=e.clone().applyQuaternion(this.dragStart.orientationWorld.clone()),h=new THREE.Ray(f,g),i=ROS3D.closestAxisPoint(h,c.camera,c.mousePos),j=new THREE.Vector3;j.addVectors(this.dragStart.position,e.clone().applyQuaternion(this.dragStart.orientation).multiplyScalar(i)),this.setPosition(a,j),c.stopPropagation()}},ROS3D.InteractiveMarker.prototype.movePlane=function(a,b,c){if(this.dragging){var d=a.currentControlOri,e=b.clone().applyQuaternion(d),f=this.dragStart.event3d.intersection.point,g=e.clone().applyQuaternion(this.dragStart.orientationWorld),h=ROS3D.intersectPlane(c.mouseRay,f,g),i=new THREE.Vector3;i.subVectors(h,f),i.add(this.dragStart.positionWorld),this.setPosition(a,i),c.stopPropagation()}},ROS3D.InteractiveMarker.prototype.rotateAxis=function(a,b,c){if(this.dragging){a.updateMatrixWorld();var d=a.currentControlOri,e=d.clone().multiply(b.clone()),f=new THREE.Vector3(1,0,0).applyQuaternion(e),g=this.dragStart.event3d.intersection.point,h=f.applyQuaternion(this.dragStart.orientationWorld),i=ROS3D.intersectPlane(c.mouseRay,g,h),j=new THREE.Ray(this.dragStart.positionWorld,h),k=ROS3D.intersectPlane(j,g,h),l=this.dragStart.orientationWorld.clone().multiply(e),m=l.clone().inverse();i.sub(k),i.applyQuaternion(m);var n=this.dragStart.event3d.intersection.point.clone();n.sub(k),n.applyQuaternion(m);var o=Math.atan2(i.y,i.z),p=Math.atan2(n.y,n.z),q=p-o,r=new THREE.Quaternion;r.setFromAxisAngle(f,q),this.setOrientation(a,r.multiply(this.dragStart.orientationWorld)),c.stopPropagation()}},ROS3D.InteractiveMarker.prototype.feedbackEvent=function(a,b){this.dispatchEvent({type:a,position:this.position.clone(),orientation:this.quaternion.clone(),controlName:b.name})},ROS3D.InteractiveMarker.prototype.startDrag=function(a,b){if(0===b.domEvent.button){b.stopPropagation(),this.dragging=!0,this.updateMatrixWorld(!0);var c=new THREE.Vector3;this.matrixWorld.decompose(this.dragStart.positionWorld,this.dragStart.orientationWorld,c),this.dragStart.position=this.position.clone(),this.dragStart.orientation=this.quaternion.clone(),this.dragStart.event3d=b,this.feedbackEvent("user-mousedown",a)}},ROS3D.InteractiveMarker.prototype.stopDrag=function(a,b){0===b.domEvent.button&&(b.stopPropagation(),this.dragging=!1,this.dragStart.event3d={},this.onServerSetPose(this.bufferedPoseEvent),this.bufferedPoseEvent=void 0,this.feedbackEvent("user-mouseup",a))},ROS3D.InteractiveMarker.prototype.buttonClick=function(a,b){b.stopPropagation(),this.feedbackEvent("user-button-click",a)},ROS3D.InteractiveMarker.prototype.setPosition=function(a,b){this.position=b,this.feedbackEvent("user-pose-change",a)},ROS3D.InteractiveMarker.prototype.setOrientation=function(a,b){b.normalize(),this.quaternion=b,this.feedbackEvent("user-pose-change",a)},ROS3D.InteractiveMarker.prototype.onServerSetPose=function(a){if(void 0!==a)if(this.dragging)this.bufferedPoseEvent=a;else{var b=a.pose;this.position.x=b.position.x,this.position.y=b.position.y,this.position.z=b.position.z,this.useQuaternion=!0,this.quaternion=new THREE.Quaternion(b.orientation.x,b.orientation.y,b.orientation.z,b.orientation.w),this.updateMatrixWorld(!0)}},ROS3D.InteractiveMarkerClient=function(a){a=a||{},this.ros=a.ros,this.tfClient=a.tfClient,this.topic=a.topic,this.path=a.path||"/",this.camera=a.camera,this.rootObject=a.rootObject||new THREE.Object3D,this.interactiveMarkers={},this.updateTopic=null,this.feedbackTopic=null,this.topic&&this.subscribe(this.topic)},ROS3D.InteractiveMarkerClient.prototype.subscribe=function(a){this.unsubscribe(),this.updateTopic=new ROSLIB.Topic({ros:this.ros,name:a+"/tunneled/update",messageType:"visualization_msgs/InteractiveMarkerUpdate",compression:"png"}),this.updateTopic.subscribe(this.processUpdate.bind(this)),this.feedbackTopic=new ROSLIB.Topic({ros:this.ros,name:a+"/feedback",messageType:"visualization_msgs/InteractiveMarkerFeedback",compression:"png"}),this.feedbackTopic.advertise(),this.initService=new ROSLIB.Service({ros:this.ros,name:a+"/tunneled/get_init",serviceType:"demo_interactive_markers/GetInit"});var b=new ROSLIB.ServiceRequest({});this.initService.callService(b,this.processInit.bind(this))},ROS3D.InteractiveMarkerClient.prototype.unsubscribe=function(){this.updateTopic&&this.updateTopic.unsubscribe(),this.feedbackTopic&&this.feedbackTopic.unadvertise();for(var a in this.interactiveMarkers)this.eraseIntMarker(a);this.interactiveMarkers={}},ROS3D.InteractiveMarkerClient.prototype.processInit=function(a){var b=a.msg;b.erases=[];for(var c in this.interactiveMarkers)b.erases.push(c);b.poses=[],this.processUpdate(b)},ROS3D.InteractiveMarkerClient.prototype.processUpdate=function(a){var b=this;a.erases.forEach(function(a){b.eraseIntMarker(a)}),a.poses.forEach(function(a){var c=b.interactiveMarkers[a.name];c&&c.setPoseFromServer(a.pose)}),a.markers.forEach(function(a){var c=b.interactiveMarkers[a.name];c&&b.eraseIntMarker(c.name);var d=new ROS3D.InteractiveMarkerHandle({message:a,feedbackTopic:b.feedbackTopic,tfClient:b.tfClient});b.interactiveMarkers[a.name]=d;var e=new ROS3D.InteractiveMarker({handle:d,camera:b.camera,path:b.path});e.name=a.name,b.rootObject.add(e),d.on("pose",function(a){e.onServerSetPose({pose:a})}),e.addEventListener("user-pose-change",d.setPoseFromClient.bind(d)),e.addEventListener("user-mousedown",d.onMouseDown.bind(d)),e.addEventListener("user-mouseup",d.onMouseUp.bind(d)),e.addEventListener("user-button-click",d.onButtonClick.bind(d)),e.addEventListener("menu-select",d.onMenuSelect.bind(d)),d.subscribeTf()})},ROS3D.InteractiveMarkerClient.prototype.eraseIntMarker=function(a){this.interactiveMarkers[a]&&(this.rootObject.remove(this.rootObject.getChildByName(a)),delete this.interactiveMarkers[a])},ROS3D.InteractiveMarkerControl=function(a){function b(a){a.stopPropagation()}var c=this;THREE.Object3D.call(this),THREE.EventDispatcher.call(this),a=a||{},this.parent=a.parent;var d=a.message;this.name=d.name,this.camera=a.camera,this.path=a.path||"/",this.dragging=!1;var e=new THREE.Quaternion(d.orientation.x,d.orientation.y,d.orientation.z,d.orientation.w);e.normalize();var f=new THREE.Vector3(1,0,0);switch(f.applyQuaternion(e),this.currentControlOri=new THREE.Quaternion,d.interaction_mode){case ROS3D.INTERACTIVE_MARKER_MOVE_AXIS:this.addEventListener("mousemove",this.parent.moveAxis.bind(this.parent,this,f)),this.addEventListener("touchmove",this.parent.moveAxis.bind(this.parent,this,f));break;case ROS3D.INTERACTIVE_MARKER_ROTATE_AXIS:this.addEventListener("mousemove",this.parent.rotateAxis.bind(this.parent,this,e));break;case ROS3D.INTERACTIVE_MARKER_MOVE_PLANE:this.addEventListener("mousemove",this.parent.movePlane.bind(this.parent,this,f));break;case ROS3D.INTERACTIVE_MARKER_BUTTON:this.addEventListener("click",this.parent.buttonClick.bind(this.parent,this))}d.interaction_mode!==ROS3D.INTERACTIVE_MARKER_NONE&&(this.addEventListener("mousedown",this.parent.startDrag.bind(this.parent,this)),this.addEventListener("mouseup",this.parent.stopDrag.bind(this.parent,this)),this.addEventListener("contextmenu",this.parent.showMenu.bind(this.parent,this)),this.addEventListener("mouseover",b),this.addEventListener("mouseout",b),this.addEventListener("click",b),this.addEventListener("touchstart",function(a){console.log(a.domEvent),1===a.domEvent.touches.length&&(a.type="mousedown",a.domEvent.button=0,c.dispatchEvent(a))}),this.addEventListener("touchmove",function(a){1===a.domEvent.touches.length&&(console.log(a.domEvent),a.type="mousemove",a.domEvent.button=0,c.dispatchEvent(a))}),this.addEventListener("touchend",function(a){0===a.domEvent.touches.length&&(a.domEvent.button=0,a.type="mouseup",c.dispatchEvent(a),a.type="click",c.dispatchEvent(a))}));var g=new THREE.Quaternion,h=this.parent.position.clone().multiplyScalar(-1);switch(d.orientation_mode){case ROS3D.INTERACTIVE_MARKER_INHERIT:g=this.parent.quaternion.clone().inverse(),this.updateMatrixWorld=function(a){ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(c,a),c.currentControlOri.copy(c.quaternion),c.currentControlOri.normalize()};break;case ROS3D.INTERACTIVE_MARKER_FIXED:this.updateMatrixWorld=function(a){c.useQuaternion=!0,c.quaternion=c.parent.quaternion.clone().inverse(),c.updateMatrix(),c.matrixWorldNeedsUpdate=!0,ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(c,a),c.currentControlOri.copy(c.quaternion)};break;case ROS3D.INTERACTIVE_MARKER_VIEW_FACING:var i=d.independentMarkerOrientation;this.updateMatrixWorld=function(a){c.camera.updateMatrixWorld();var b=(new THREE.Matrix4).extractRotation(c.camera.matrixWorld),d=new THREE.Matrix4,e=.5*Math.PI,f=new THREE.Vector3(-e,0,e);d.setRotationFromEuler(f);var g=new THREE.Matrix4;g.getInverse(c.parent.matrixWorld),b.multiplyMatrices(b,d),b.multiplyMatrices(g,b),c.currentControlOri.setFromRotationMatrix(b),i||(c.useQuaternion=!0,c.quaternion.copy(c.currentControlOri),c.updateMatrix(),c.matrixWorldNeedsUpdate=!0),ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(c,a)};break;default:console.error("Unkown orientation mode: "+d.orientation_mode)}d.markers.forEach(function(a){var b=new ROS3D.Marker({message:a,path:c.path});""!==a.header.frame_id&&(b.position.add(h),b.position.applyQuaternion(g),b.quaternion.multiplyQuaternions(g,b.quaternion),b.updateMatrixWorld()),c.add(b)})},ROS3D.InteractiveMarkerControl.prototype.__proto__=THREE.Object3D.prototype,ROS3D.InteractiveMarkerHandle=function(a){a=a||{},this.message=a.message,this.feedbackTopic=a.feedbackTopic,this.tfClient=a.tfClient,this.name=this.message.name,this.header=this.message.header,this.controls=this.message.controls,this.menuEntries=this.message.menu_entries,this.dragging=!1,this.timeoutHandle=null,this.tfTransform=new ROSLIB.Transform,this.pose=new ROSLIB.Pose,this.setPoseFromServer(this.message.pose)},ROS3D.InteractiveMarkerHandle.prototype.__proto__=EventEmitter2.prototype,ROS3D.InteractiveMarkerHandle.prototype.subscribeTf=function(){0===this.message.header.stamp.secs&&0===this.message.header.stamp.nsecs&&this.tfClient.subscribe(this.message.header.frame_id,this.tfUpdate.bind(this))},ROS3D.InteractiveMarkerHandle.prototype.emitServerPoseUpdate=function(){var a=new ROSLIB.Pose(this.pose);a.applyTransform(this.tfTransform),this.emit("pose",a)},ROS3D.InteractiveMarkerHandle.prototype.setPoseFromServer=function(a){this.pose=new ROSLIB.Pose(a),this.emitServerPoseUpdate()},ROS3D.InteractiveMarkerHandle.prototype.tfUpdate=function(a){this.tfTransform=new ROSLIB.Transform(a),this.emitServerPoseUpdate()},ROS3D.InteractiveMarkerHandle.prototype.setPoseFromClient=function(a){this.pose=new ROSLIB.Pose(a);var b=this.tfTransform.clone();b.rotation.invert(),b.translation.multiplyQuaternion(b.rotation),b.translation.x*=-1,b.translation.y*=-1,b.translation.z*=-1,this.pose.applyTransform(b),this.sendFeedback(ROS3D.INTERACTIVE_MARKER_POSE_UPDATE,void 0,0,a.controlName),this.dragging&&(this.timeoutHandle&&clearTimeout(this.timeoutHandle),this.timeoutHandle=setTimeout(this.setPoseFromClient.bind(this,a),250))},ROS3D.InteractiveMarkerHandle.prototype.onButtonClick=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_BUTTON_CLICK,a.clickPosition,0,a.controlName)},ROS3D.InteractiveMarkerHandle.prototype.onMouseDown=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MOUSE_DOWN,a.clickPosition,0,a.controlName),this.dragging=!0},ROS3D.InteractiveMarkerHandle.prototype.onMouseUp=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MOUSE_UP,a.clickPosition,0,a.controlName),this.dragging=!1,this.timeoutHandle&&clearTimeout(this.timeoutHandle)},ROS3D.InteractiveMarkerHandle.prototype.onMenuSelect=function(a){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MENU_SELECT,void 0,a.id,a.controlName)},ROS3D.InteractiveMarkerHandle.prototype.sendFeedback=function(a,b,c,d){var e=void 0!==b;b=b||{x:0,y:0,z:0};var f={header:this.header,client_id:this.clientID,marker_name:this.name,control_name:d,event_type:a,pose:this.pose,mouse_point:b,mouse_point_valid:e,menu_entry_id:c};this.feedbackTopic.publish(f)},ROS3D.InteractiveMarkerMenu=function(a){function b(a,b){this.dispatchEvent({type:"menu-select",domEvent:b,id:a.id,controlName:this.controlName}),this.hide(b)}function c(a,e){var f=document.createElement("ul");a.appendChild(f);for(var g=e.children,h=0;h<g.length;h++){var i=document.createElement("li"),j=document.createElement("div");j.appendChild(document.createTextNode(g[h].title)),f.appendChild(i),i.appendChild(j),g[h].children.length>0?(c(i,g[h]),j.addEventListener("click",d.hide.bind(d))):(j.addEventListener("click",b.bind(d,g[h])),j.className="default-interactive-marker-menu-entry")}}var d=this;a=a||{};var e=a.menuEntries,f=a.className||"default-interactive-marker-menu";a.entryClassName||"default-interactive-marker-menu-entry";var g=a.overlayClassName||"default-interactive-marker-overlay",h=[];if(h[0]={children:[]},THREE.EventDispatcher.call(this),null===document.getElementById("default-interactive-marker-menu-css")){var i=document.createElement("style");i.id="default-interactive-marker-menu-css",i.type="text/css",i.innerHTML=".default-interactive-marker-menu {background-color: #444444;border: 1px solid #888888;border: 1px solid #888888;padding: 0px 0px 0px 0px;color: #FFFFFF;font-family: sans-serif;font-size: 0.8em;z-index: 1002;}.default-interactive-marker-menu ul {padding: 0px 0px 5px 0px;margin: 0px;list-style-type: none;}.default-interactive-marker-menu ul li div {-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;cursor: default;padding: 3px 10px 3px 10px;}.default-interactive-marker-menu-entry:hover {  background-color: #666666;  cursor: pointer;}.default-interactive-marker-menu ul ul {  font-style: italic;  padding-left: 10px;}.default-interactive-marker-overlay {  position: absolute;  top: 0%;  left: 0%;  width: 100%;  height: 100%;  background-color: black;  z-index: 1001;  -moz-opacity: 0.0;  opacity: .0;  filter: alpha(opacity = 0);}",document.getElementsByTagName("head")[0].appendChild(i)}this.menuDomElem=document.createElement("div"),this.menuDomElem.style.position="absolute",this.menuDomElem.className=f,this.menuDomElem.addEventListener("contextmenu",function(a){a.preventDefault()}),this.overlayDomElem=document.createElement("div"),this.overlayDomElem.className=g,this.hideListener=this.hide.bind(this),this.overlayDomElem.addEventListener("contextmenu",this.hideListener),this.overlayDomElem.addEventListener("click",this.hideListener);var j,k,l;for(j=0;j<e.length;j++)k=e[j],l=k.id,h[l]={title:k.title,id:l,children:[]};for(j=0;j<e.length;j++){k=e[j],l=k.id;var m=h[l],n=h[k.parent_id];n.children.push(m)}c(this.menuDomElem,h[0])},ROS3D.InteractiveMarkerMenu.prototype.show=function(a,b){b&&b.preventDefault&&b.preventDefault(),this.controlName=a.name,this.menuDomElem.style.left=b.domEvent.clientX+"px",this.menuDomElem.style.top=b.domEvent.clientY+"px",document.body.appendChild(this.overlayDomElem),document.body.appendChild(this.menuDomElem)},ROS3D.InteractiveMarkerMenu.prototype.hide=function(a){a&&a.preventDefault&&a.preventDefault(),document.body.removeChild(this.overlayDomElem),document.body.removeChild(this.menuDomElem)},ROS3D.OccupancyGrid=function(a){a=a||{};var b=a.message,c=b.info.width,d=b.info.height,e=new THREE.PlaneGeometry(c,d),f=document.createElement("canvas");f.width=c,f.height=d;for(var g=f.getContext("2d"),h=g.createImageData(c,d),i=0;d>i;i++)for(var j=0;c>j;j++){var k,l=j+(d-i-1)*c,m=b.data[l];k=100===m?0:0===m?255:127;var n=4*(j+i*c);h.data[n]=k,h.data[++n]=k,h.data[++n]=k,h.data[++n]=255}g.putImageData(h,0,0);var o=new THREE.Texture(f);o.needsUpdate=!0;var p=new THREE.MeshBasicMaterial({map:o});p.side=THREE.DoubleSide,THREE.Mesh.call(this,e,p),this.position.x=c*b.info.resolution/2,this.position.y=d*b.info.resolution/2,this.scale.x=b.info.resolution,this.scale.y=b.info.resolution},ROS3D.OccupancyGrid.prototype.__proto__=THREE.Mesh.prototype,ROS3D.OccupancyGridClient=function(a){var b=this;a=a||{};var c=a.ros,d=a.topic||"/map";this.continuous=a.continuous,this.tfClient=a.tfClient,this.rootObject=a.rootObject||new THREE.Object3D,this.currentGrid=null;var e=new ROSLIB.Topic({ros:c,name:d,messageType:"nav_msgs/OccupancyGrid",compression:"png"});e.subscribe(function(a){b.currentGrid&&b.rootObject.remove(b.currentGrid);var c=new ROS3D.OccupancyGrid({message:a});b.currentGrid=b.tfClient?new ROS3D.SceneNode({frameID:a.header.frame_id,tfClient:b.tfClient,object:c,pose:a.info.origin}):c,b.rootObject.add(b.currentGrid),b.emit("change"),b.continuous||e.unsubscribe()})},ROS3D.OccupancyGridClient.prototype.__proto__=EventEmitter2.prototype,ROS3D.Marker=function(a){a=a||{};var b=a.path||"/",c=a.message;"/"!==b.substr(b.length-1)&&(b+="/"),THREE.Object3D.call(this),this.useQuaternion=!0,this.setPose(c.pose);var d=ROS3D.makeColorMaterial(c.color.r,c.color.g,c.color.b,c.color.a);switch(c.type){case ROS3D.MARKER_ARROW:var e,f=c.scale.x,g=.23*f,h=c.scale.y,i=.5*h,j=null;if(2===c.points.length){j=new THREE.Vector3(c.points[0].x,c.points[0].y,c.points[0].z);var k=new THREE.Vector3(c.points[1].x,c.points[1].y,c.points[1].z);e=j.clone().negate().add(k),f=e.length(),h=c.scale.y,i=c.scale.x,0!==c.scale.z&&(g=c.scale.z)}this.add(new ROS3D.Arrow({direction:e,origin:j,length:f,headLength:g,shaftDiameter:i,headDiameter:h,material:d}));break;case ROS3D.MARKER_CUBE:var l=new THREE.CubeGeometry(c.scale.x,c.scale.y,c.scale.z);this.add(new THREE.Mesh(l,d));break;case ROS3D.MARKER_SPHERE:var m=new THREE.SphereGeometry(.5),n=new THREE.Mesh(m,d);n.scale.x=c.scale.x,n.scale.y=c.scale.y,n.scale.z=c.scale.z,this.add(n);break;case ROS3D.MARKER_CYLINDER:var o=new THREE.CylinderGeometry(.5,.5,1,16,1,!1),p=new THREE.Mesh(o,d);p.useQuaternion=!0,p.quaternion.setFromAxisAngle(new THREE.Vector3(1,0,0),.5*Math.PI),p.scale=new THREE.Vector3(c.scale.x,c.scale.z,c.scale.y),this.add(p);break;case ROS3D.MARKER_CUBE_LIST:var q,r,s,t,u=new THREE.Object3D,v=c.points.length,w=v===c.colors.length,x=Math.ceil(v/1250);for(q=0;v>q;q+=x)r=new THREE.CubeGeometry(c.scale.x,c.scale.y,c.scale.z),s=w?ROS3D.makeColorMaterial(c.colors[q].r,c.colors[q].g,c.colors[q].b,c.colors[q].a):d,t=new THREE.Mesh(r,s),t.position.x=c.points[q].x,t.position.y=c.points[q].y,t.position.z=c.points[q].z,u.add(t);this.add(u);break;case ROS3D.MARKER_SPHERE_LIST:case ROS3D.MARKER_POINTS:var y,z=new THREE.Geometry,A=new THREE.ParticleBasicMaterial({size:c.scale.x});for(y=0;y<c.points.length;y++){var B=new THREE.Vector3;B.x=c.points[y].x,B.y=c.points[y].y,B.z=c.points[y].z,z.vertices.push(B)}if(c.colors.length===c.points.length)for(A.vertexColors=!0,y=0;y<c.points.length;y++){var C=new THREE.Color;C.setRGB(c.colors[y].r,c.colors[y].g,c.colors[y].b),z.colors.push(C)}else A.color.setRGB(c.color.r,c.color.g,c.color.b);this.add(new THREE.ParticleSystem(z,A));break;case ROS3D.MARKER_TEXT_VIEW_FACING:var D=new THREE.TextGeometry(c.text,{size:.5*c.scale.x,height:.1*c.scale.x,curveSegments:4,font:"helvetiker",bevelEnabled:!1,bevelThickness:2,bevelSize:2,material:0,extrudeMaterial:0});D.computeVertexNormals(),D.computeBoundingBox();var E=new THREE.Mesh(D,d),F=-.5*(D.boundingBox.max.x-D.boundingBox.min.x);E.position.y=-F,E.rotation.x=.5*Math.PI,E.rotation.y=1.5*Math.PI,this.add(E);break;case ROS3D.MARKER_MESH_RESOURCE:var G=null;(0!==c.color.r||0!==c.color.g||0!==c.color.b||0!==c.color.a)&&(G=d);var H=new ROS3D.MeshResource({path:b,resource:c.mesh_resource.substr(10),material:G});this.add(H);break;case ROS3D.MARKER_TRIANGLE_LIST:var I=new ROS3D.TriangleList({material:d,vertices:c.points,colors:c.colors});I.scale=new THREE.Vector3(c.scale.x,c.scale.y,c.scale.z),this.add(I);break;default:console.error("Currently unsupported marker type: "+c.type)}},ROS3D.Marker.prototype.__proto__=THREE.Object3D.prototype,ROS3D.Marker.prototype.setPose=function(a){this.position.x=a.position.x,this.position.y=a.position.y,this.position.z=a.position.z,this.quaternion=new THREE.Quaternion(a.orientation.x,a.orientation.y,a.orientation.z,a.orientation.w),this.quaternion.normalize(),this.updateMatrixWorld()},ROS3D.MarkerClient=function(a){var b=this;a=a||{};var c=a.ros,d=a.topic;this.tfClient=a.tfClient,this.rootObject=a.rootObject||new THREE.Object3D,this.currentMarker=null;var e=new ROSLIB.Topic({ros:c,name:d,messageType:"visualization_msgs/Marker",compression:"png"});e.subscribe(function(a){var c=new ROS3D.Marker({message:a});b.currentMarker&&b.rootObject.remove(b.currentMarker),b.currentMarker=new ROS3D.SceneNode({frameID:a.header.frame_id,tfClient:b.tfClient,object:c}),b.rootObject.add(b.currentMarker),b.emit("change")})},ROS3D.MarkerClient.prototype.__proto__=EventEmitter2.prototype,ROS3D.Arrow=function(a){a=a||{};var b=a.origin||new THREE.Vector3(0,0,0),c=a.direction||new THREE.Vector3(1,0,0),d=a.length||1,e=a.headLength||.2,f=a.shaftDiameter||.05,g=a.headDiameter||.1,h=a.material||new THREE.MeshBasicMaterial,i=d-e,j=new THREE.CylinderGeometry(.5*f,.5*f,i,12,1),k=new THREE.Matrix4;k.setPosition(new THREE.Vector3(0,.5*i,0)),j.applyMatrix(k);var l=new THREE.CylinderGeometry(0,.5*g,e,12,1);k.setPosition(new THREE.Vector3(0,i+.5*e,0)),l.applyMatrix(k),THREE.GeometryUtils.merge(j,l),THREE.Mesh.call(this,j,h),this.position=b,this.setDirection(c)},ROS3D.Arrow.prototype.__proto__=THREE.Mesh.prototype,ROS3D.Arrow.prototype.setDirection=function(a){var b=new THREE.Vector3(0,1,0).cross(a),c=Math.acos(new THREE.Vector3(0,1,0).dot(a.clone().normalize()));this.matrix=(new THREE.Matrix4).makeRotationAxis(b.normalize(),c),this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder)},ROS3D.Arrow.prototype.setLength=function(a){this.scale.set(a,a,a)},ROS3D.Arrow.prototype.setColor=function(a){this.line.material.color.setHex(a),this.cone.material.color.setHex(a)},ROS3D.Axes=function(a){function b(a){var b=new THREE.Color;b.setRGB(a.x,a.y,a.z);var d=new THREE.MeshBasicMaterial({color:b.getHex()}),e=new THREE.Vector3;e.crossVectors(a,new THREE.Vector3(0,-1,0));var f=new THREE.Quaternion;f.setFromAxisAngle(e,.5*Math.PI);var g=new THREE.Mesh(c.headGeom,d);g.position=a.clone(),g.position.multiplyScalar(.95),g.useQuaternion=!0,g.quaternion=f,g.updateMatrix(),c.add(g);var h=new THREE.Mesh(c.lineGeom,d);h.position=a.clone(),h.position.multiplyScalar(.45),h.useQuaternion=!0,h.quaternion=f,h.updateMatrix(),c.add(h)}var c=this;a=a||{};
var d=a.shaftRadius||.008,e=a.headRadius||.023,f=a.headLength||.1;THREE.Object3D.call(this),this.lineGeom=new THREE.CylinderGeometry(d,d,1-f),this.headGeom=new THREE.CylinderGeometry(0,e,f),b(new THREE.Vector3(1,0,0)),b(new THREE.Vector3(0,1,0)),b(new THREE.Vector3(0,0,1))},ROS3D.Axes.prototype.__proto__=THREE.Object3D.prototype,ROS3D.Grid=function(a){a=a||{};var b=a.size||50,c=a.color||"#cccccc",d=a.lineWidth||1;THREE.Mesh.call(this,new THREE.PlaneGeometry(b,b,b,b),new THREE.MeshBasicMaterial({color:c,wireframe:!0,wireframeLinewidth:d,transparent:!0}))},ROS3D.Grid.prototype.__proto__=THREE.Mesh.prototype,ROS3D.MeshResource=function(a){var b=this;a=a||{};var c=a.path||"/",d=a.resource,e=a.material||null;this.warnings=a.warnings,THREE.Object3D.call(this),"/"!==c.substr(c.length-1)&&(this.path+="/");var f=c+d;if(f.substr(-4).toLowerCase(),".dae"===f.substr(-4).toLowerCase()){var g=new ColladaLoader2;g.log=function(a){b.warnings&&console.warn(a)},g.load(f,function(a){if(a.dae.asset.unit){var c=a.dae.asset.unit;a.scene.scale=new THREE.Vector3(c,c,c)}if(null!==e){var d=function(a,b){if(a.material=b,a.children)for(var c=0;c<a.children.length;c++)d(a.children[c],b)};d(a.scene,e)}b.add(a.scene)})}},ROS3D.MeshResource.prototype.__proto__=THREE.Object3D.prototype,ROS3D.TriangleList=function(a){a=a||{};var b=a.material||new THREE.MeshBasicMaterial,c=a.vertices,d=a.colors;THREE.Object3D.call(this),b.side=THREE.DoubleSide;var e=new THREE.Geometry;for(f=0;f<c.length;f++)e.vertices.push(new THREE.Vector3(c[f].x,c[f].y,c[f].z));var f,g;if(d.length===c.length){for(f=0;f<c.length;f+=3){var h=new THREE.Face3(f,f+1,f+2);for(g=3*f;3*f+3>g;f++){var i=new THREE.Color;i.setRGB(d[f].r,d[f].g,d[f].b),h.vertexColors.push(i)}e.faces.push(k)}b.vertexColors=THREE.VertexColors}else if(d.length===c.length/3){for(f=0;f<c.length;f+=3){var j=new THREE.Face3(f,f+1,f+2);j.color.setRGB(d[f/3].r,d[f/3].g,d[f/3].b),e.faces.push(j)}b.vertexColors=THREE.FaceColors}else for(f=0;f<c.length;f+=3){var k=new THREE.Face3(f,f+1,f+2);e.faces.push(k)}e.computeBoundingBox(),e.computeBoundingSphere(),e.computeCentroids(),e.computeFaceNormals(),this.add(new THREE.Mesh(e,b))},ROS3D.TriangleList.prototype.__proto__=THREE.Object3D.prototype,ROS3D.TriangleList.prototype.setColor=function(a){this.mesh.material.color.setHex(a)},ROS3D.Urdf=function(a){a=a||{};var b=a.urdfModel,c=a.path||"/",d=a.tfClient;THREE.Object3D.call(this),this.useQuaternion=!0;var e=b.links;for(var f in e){var g=e[f];if(g.visual&&g.visual.geometry&&g.visual.geometry.type===ROSLIB.URDF_MESH){var h="/"+g.name,i=g.visual.geometry.filename,j=i.substr(-4).toLowerCase();if(".dae"===j){var k=new ROS3D.MeshResource({path:c,resource:i.substring(10)});g.visual.geometry.scale&&(k.scale=new THREE.Vector3(g.visual.geometry.scale.x,g.visual.geometry.scale.y,g.visual.geometry.scale.z));var l=new ROS3D.SceneNode({frameID:h,pose:g.visual.origin,tfClient:d,object:k});this.add(l)}}}},ROS3D.Urdf.prototype.__proto__=THREE.Object3D.prototype,ROS3D.UrdfClient=function(a){var b=this;a=a||{};var c=a.ros,d=a.param||"robot_description";this.path=a.path||"/",this.tfClient=a.tfClient,this.rootObject=a.rootObject||new THREE.Object3D;var e=new ROSLIB.Param({ros:c,name:d});e.get(function(a){var c=new ROSLIB.UrdfModel({string:a});b.rootObject.add(new ROS3D.Urdf({urdfModel:c,path:b.path,tfClient:b.tfClient}))})},ROS3D.SceneNode=function(a){a=a||{};var b=this,c=a.tfClient,d=a.frameID,e=a.object;this.pose=a.pose||new ROSLIB.Pose,THREE.Object3D.call(this),this.useQuaternion=!0,this.add(e),this.updatePose(this.pose),c.subscribe(d,function(a){var c=new ROSLIB.Transform(a),d=new ROSLIB.Pose(b.pose);d.applyTransform(c),b.updatePose(d)})},ROS3D.SceneNode.prototype.__proto__=THREE.Object3D.prototype,ROS3D.SceneNode.prototype.updatePose=function(a){this.position.x=a.position.x,this.position.y=a.position.y,this.position.z=a.position.z,this.quaternion=new THREE.Quaternion(a.orientation.x,a.orientation.y,a.orientation.z,a.orientation.w),this.updateMatrixWorld(!0)},ROS3D.Viewer=function(a){function b(){c.cameraControls.update(),c.directionalLight.position=c.camera.localToWorld(new THREE.Vector3(-1,1,0)),c.directionalLight.position.normalize(),c.renderer.clear(!0,!0,!0),c.renderer.render(c.scene,c.camera),c.highlighter.renderHighlight(c.renderer,c.scene,c.camera),requestAnimationFrame(b)}var c=this;a=a||{};var d=a.divID,e=a.width,f=a.height,g=a.background||"#111111";a.antialias;var h=a.intensity||.66,i=a.cameraPose||{x:3,y:3,z:3};this.renderer=new THREE.WebGLRenderer({antialias:this.antialias}),this.renderer.setClearColorHex(g.replace("#","0x"),1),this.renderer.sortObjects=!1,this.renderer.setSize(e,f),this.renderer.shadowMapEnabled=!1,this.renderer.autoClear=!1,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(40,e/f,.01,1e3),this.camera.position.x=i.x,this.camera.position.y=i.y,this.camera.position.z=i.z,this.cameraControls=new ROS3D.OrbitControls({scene:this.scene,camera:this.camera}),this.cameraControls.userZoomSpeed=.5,this.scene.add(new THREE.AmbientLight(5592405)),this.directionalLight=new THREE.DirectionalLight(16777215,h),this.scene.add(this.directionalLight),this.selectableObjects=new THREE.Object3D,this.scene.add(this.selectableObjects);var j=new ROS3D.MouseHandler({renderer:this.renderer,camera:this.camera,rootObject:this.selectableObjects,fallbackTarget:this.cameraControls});this.highlighter=new ROS3D.Highlighter({mouseHandler:j}),document.getElementById(d).appendChild(this.renderer.domElement),b()},ROS3D.Viewer.prototype.addObject=function(a,b){b?this.selectableObjects.add(a):this.scene.add(a)},ROS3D.Highlighter=function(a){a=a||{};var b=a.mouseHandler;this.hoverObjs=[],b.addEventListener("mouseover",this.onMouseOver.bind(this)),b.addEventListener("mouseout",this.onMouseOut.bind(this))},ROS3D.Highlighter.prototype.onMouseOver=function(a){this.hoverObjs.push(a.currentTarget)},ROS3D.Highlighter.prototype.onMouseOut=function(a){this.hoverObjs.splice(this.hoverObjs.indexOf(a.currentTarget),1)},ROS3D.Highlighter.prototype.getWebglObjects=function(a,b,c){for(var d=a.__webglObjects,e=0;e<b.length;e++)if(b[e]){for(var f=d.length-1;f>=0;f--)if(d[f].object===b[e]){c.push(d[f]);break}this.getWebglObjects(a,b[e].children,c)}},ROS3D.Highlighter.prototype.renderHighlight=function(a,b,c){var d=[];this.getWebglObjects(b,this.hoverObjs,d),b.overrideMaterial=new THREE.MeshBasicMaterial({fog:!1,opacity:.5,depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetUnits:-1,side:THREE.DoubleSide});var e=b.__webglObjects;b.__webglObjects=d,a.render(b,c),b.__webglObjects=e,b.overrideMaterial=null},ROS3D.MouseHandler=function(a){THREE.EventDispatcher.call(this),this.renderer=a.renderer,this.camera=a.camera,this.rootObject=a.rootObject,this.fallbackTarget=a.fallbackTarget,this.lastTarget=this.fallbackTarget,this.dragging=!1,this.projector=new THREE.Projector;var b=["contextmenu","click","dblclick","mouseout","mousedown","mouseup","mousemove","mousewheel","DOMMouseScroll","touchstart","touchend","touchcancel","touchleave","touchmove"];this.listeners={},b.forEach(function(a){this.listeners[a]=this.processDomEvent.bind(this),this.renderer.domElement.addEventListener(a,this.listeners[a],!1)},this)},ROS3D.MouseHandler.prototype.processDomEvent=function(a){a.preventDefault();var b,c,d=a.target,e=d.getBoundingClientRect();-1!==a.type.indexOf("touch")?(b=a.changedTouches[0].clientX,c=a.changedTouches[0].clientY):(b=a.clientX,c=a.clientY);var f=b-e.left-d.clientLeft+d.scrollLeft,g=c-e.top-d.clientTop+d.scrollTop,h=2*(f/d.clientWidth)-1,i=2*(-g/d.clientHeight)+1,j=new THREE.Vector3(h,i,.5);this.projector.unprojectVector(j,this.camera);var k=new THREE.Raycaster(this.camera.position.clone(),j.sub(this.camera.position).normalize()),l=k.ray,m={mousePos:new THREE.Vector2(h,i),mouseRay:l,domEvent:a,camera:this.camera,intersection:this.lastIntersection};if("mouseout"===a.type)return this.dragging&&(this.notify(this.lastTarget,"mouseup",m),this.dragging=!1),this.notify(this.lastTarget,"mouseout",m),this.lastTarget=null,void 0;if("touchleave"===a.type||"touchend"===a.type)return this.dragging&&(this.notify(this.lastTarget,"mouseup",m),this.dragging=!1),this.notify(this.lastTarget,"touchend",m),this.lastTarget=null,void 0;if(this.dragging)return this.notify(this.lastTarget,a.type,m),("mouseup"===a.type&&2===a.button||"click"===a.type||"touchend"===a.type)&&(this.dragging=!1),void 0;d=this.lastTarget;var n=[];if(n=k.intersectObject(this.rootObject,!0),n.length>0?(d=n[0].object,m.intersection=this.lastIntersection=n[0]):d=this.fallbackTarget,d!==this.lastTarget&&a.type.match(/mouse/)){var o=this.notify(d,"mouseover",m);o?this.notify(this.lastTarget,"mouseout",m):(d=this.fallbackTarget,d!==this.lastTarget&&(this.notify(d,"mouseover",m),this.notify(this.lastTarget,"mouseout",m)))}if(d!==this.lastTarget&&a.type.match(/touch/)){var p=this.notify(d,a.type,m);p?(this.notify(this.lastTarget,"touchleave",m),this.notify(this.lastTarget,"touchend",m)):(d=this.fallbackTarget,d!==this.lastTarget&&(this.notify(this.lastTarget,"touchmove",m),this.notify(this.lastTarget,"touchend",m)))}this.notify(d,a.type,m),("mousedown"===a.type||"touchstart"===a.type||"touchmove"===a.type)&&(this.dragging=!0),this.lastTarget=d},ROS3D.MouseHandler.prototype.notify=function(a,b,c){for(c.type=b,c.cancelBubble=!1,c.stopPropagation=function(){c.cancelBubble=!0},c.currentTarget=a;c.currentTarget;){if(c.currentTarget.dispatchEvent&&c.currentTarget.dispatchEvent instanceof Function&&(c.currentTarget.dispatchEvent(c),c.cancelBubble))return this.dispatchEvent(c),!0;c.currentTarget=c.currentTarget.parent}return!1},ROS3D.OrbitControls=function(a){function b(a){var b=a.domEvent;switch(b.preventDefault(),b.button){case 0:w=v.ROTATE,l.set(b.clientX,b.clientY);break;case 1:w=v.MOVE,s=new THREE.Vector3(0,0,1);var c=(new THREE.Matrix4).extractRotation(this.camera.matrix);s.applyMatrix4(c),r=i.center.clone(),t=i.camera.position.clone(),u=d(a.mouseRay,r,s);break;case 2:w=v.ZOOM,o.set(b.clientX,b.clientY)}this.showAxes()}function c(a){var b=a.domEvent;if(w===v.ROTATE)m.set(b.clientX,b.clientY),n.subVectors(m,l),i.rotateLeft(2*Math.PI*n.x/k*i.userRotateSpeed),i.rotateUp(2*Math.PI*n.y/k*i.userRotateSpeed),l.copy(m),this.showAxes();else if(w===v.ZOOM)p.set(b.clientX,b.clientY),q.subVectors(p,o),q.y>0?i.zoomIn():i.zoomOut(),o.copy(p),this.showAxes();else if(w===v.MOVE){var c=d(a.mouseRay,i.center,s);if(!c)return;var e=(new THREE.Vector3).subVectors(u.clone(),c.clone());i.center.addVectors(r.clone(),e.clone()),i.camera.position.addVectors(t.clone(),e.clone()),i.update(),i.camera.updateMatrixWorld(),this.showAxes()}}function d(a,b,c){var d=new THREE.Vector3,e=new THREE.Vector3;d.subVectors(b,a.origin);var f=a.direction.dot(c);if(Math.abs(f)<a.precision)return null;var g=c.dot(d)/f;return e=a.direction.clone().multiplyScalar(g)}function e(){i.userRotate&&(w=v.NONE)}function f(a){if(i.userZoom){var b,c=a.domEvent;b="undefined"!=typeof c.wheelDelta?c.wheelDelta:-c.detail,b>0?i.zoomIn():i.zoomOut(),this.showAxes()}}function g(a){var b=a.domEvent;switch(console.log(">> button: "+b.button),b.touches.length){case 1:w=v.ROTATE,l.set(b.changedTouches[0].pageX-window.scrollX,b.changedTouches[0].pageY-window.scrollY),s=new THREE.Vector3(0,0,1);var c=(new THREE.Matrix4).extractRotation(this.camera.matrix);s.applyMatrix4(c),r=i.center.clone(),t=i.camera.position.clone(),u=d(a.mouseRay,r,s);break;case 2:w=v.ZOOM,o.set((b.changedTouches[0].pageX-b.changedTouches[1].pageX)*(b.changedTouches[0].pageX-b.changedTouches[1].pageX),(b.changedTouches[0].pageY-b.changedTouches[1].pageY)*(b.changedTouches[0].pageY-b.changedTouches[1].pageY));break;case 3:w=v.MOVE}this.showAxes(),b.preventDefault()}function h(a){var b=a.domEvent;if(console.log(w),w===v.ROTATE)m.set(b.changedTouches[0].pageX-window.scrollX,b.changedTouches[0].pageY-window.scrollY),n.subVectors(m,l),i.rotateLeft(2*Math.PI*n.x/k*i.userRotateSpeed),i.rotateUp(2*Math.PI*n.y/k*i.userRotateSpeed),l.copy(m),this.showAxes();else if(w===v.ZOOM)p.set((b.changedTouches[0].pageX-b.changedTouches[1].pageX)*(b.changedTouches[0].pageX-b.changedTouches[1].pageX),(b.changedTouches[0].pageY-b.changedTouches[1].pageY)*(b.changedTouches[0].pageY-b.changedTouches[1].pageY)),q.subVectors(p,o),q.y>0?i.zoomOut():i.zoomIn(),o.copy(p),this.showAxes();else if(w===v.MOVE){var c=d(a.mouseRay,i.center,s);if(!c)return;var e=(new THREE.Vector3).subVectors(u.clone(),c.clone());i.center.addVectors(r.clone(),e.clone()),i.camera.position.addVectors(t.clone(),e.clone()),i.update(),i.camera.updateMatrixWorld(),this.showAxes()}b.preventDefault()}THREE.EventDispatcher.call(this);var i=this;a=a||{};var j=a.scene;this.camera=a.camera,this.center=new THREE.Vector3,this.userZoom=!0,this.userZoomSpeed=a.userZoomSpeed||1,this.userRotate=!0,this.userRotateSpeed=a.userRotateSpeed||1,this.autoRotate=a.autoRotate,this.autoRotateSpeed=a.autoRotateSpeed||2,this.camera.up=new THREE.Vector3(0,0,1);var k=1800,l=new THREE.Vector2,m=new THREE.Vector2,n=new THREE.Vector2,o=new THREE.Vector2,p=new THREE.Vector2,q=new THREE.Vector2,r=new THREE.Vector3,s=new THREE.Vector3,t=new THREE.Vector3,u=new THREE.Vector3;this.phiDelta=0,this.thetaDelta=0,this.scale=1,this.lastPosition=new THREE.Vector3;var v={NONE:-1,ROTATE:0,ZOOM:1,MOVE:2},w=v.NONE;this.axes=new ROS3D.Axes({shaftRadius:.025,headRadius:.07,headLength:.2}),j.add(this.axes),this.axes.traverse(function(a){a.visible=!1}),this.addEventListener("mousedown",b),this.addEventListener("mouseup",e),this.addEventListener("mousemove",c),this.addEventListener("touchstart",g),this.addEventListener("touchmove",h),this.addEventListener("touchend",e),this.addEventListener("mousewheel",f),this.addEventListener("DOMMouseScroll",f)},ROS3D.OrbitControls.prototype.showAxes=function(){var a=this;this.axes.traverse(function(a){a.visible=!0}),this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(function(){a.axes.traverse(function(a){a.visible=!1}),a.hideTimeout=!1},1e3)},ROS3D.OrbitControls.prototype.rotateLeft=function(a){void 0===a&&(a=2*Math.PI/60/60*this.autoRotateSpeed),this.thetaDelta-=a},ROS3D.OrbitControls.prototype.rotateRight=function(a){void 0===a&&(a=2*Math.PI/60/60*this.autoRotateSpeed),this.thetaDelta+=a},ROS3D.OrbitControls.prototype.rotateUp=function(a){void 0===a&&(a=2*Math.PI/60/60*this.autoRotateSpeed),this.phiDelta-=a},ROS3D.OrbitControls.prototype.rotateDown=function(a){void 0===a&&(a=2*Math.PI/60/60*this.autoRotateSpeed),this.phiDelta+=a},ROS3D.OrbitControls.prototype.zoomIn=function(a){void 0===a&&(a=Math.pow(.95,this.userZoomSpeed)),this.scale/=a},ROS3D.OrbitControls.prototype.zoomOut=function(a){void 0===a&&(a=Math.pow(.95,this.userZoomSpeed)),this.scale*=a},ROS3D.OrbitControls.prototype.update=function(){var a=this.camera.position,b=a.clone().sub(this.center),c=Math.atan2(b.y,b.x),d=Math.atan2(Math.sqrt(b.y*b.y+b.x*b.x),b.z);this.autoRotate&&this.rotateLeft(2*Math.PI/60/60*this.autoRotateSpeed),c+=this.thetaDelta,d+=this.phiDelta;var e=1e-6;d=Math.max(e,Math.min(Math.PI-e,d));var f=b.length();b.y=f*Math.sin(d)*Math.sin(c),b.z=f*Math.cos(d),b.x=f*Math.sin(d)*Math.cos(c),b.multiplyScalar(this.scale),a.copy(this.center).add(b),this.camera.lookAt(this.center),f=b.length(),this.axes.position=this.center.clone(),this.axes.scale.x=this.axes.scale.y=this.axes.scale.z=.05*f,this.axes.updateMatrixWorld(!0),this.thetaDelta=0,this.phiDelta=0,this.scale=1,this.lastPosition.distanceTo(this.camera.position)>0&&(this.dispatchEvent({type:"change"}),this.lastPosition.copy(this.camera.position))};